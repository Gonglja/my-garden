---
{"dg-publish":true,"permalink":"/ğŸŒ¿ æ–‡çŒ®ç¬”è®°/linux 0.11 æºç åˆ†æ/","tags":["Linux","Linux/kernel","æºç åˆ†æ"]}
---


# Linux 0.11 ç¯å¢ƒæ­å»ºä¸é˜…è¯»

## èƒŒæ™¯

æ›´å¥½çš„å­¦ä¹  linux å†…æ ¸æ€æƒ³ï¼Œåšä¸€ä¸ªæœ‰æƒ³æ³•çš„äººã€‚

## åè¯çº¦å®š

- CPLï¼šCurrent privilege levelï¼Œå½“å‰æƒé™çº§åˆ«
- DPLï¼šDescriptor privilege levelï¼Œ
- RPLï¼šRequested privilege levelï¼Œè¯·æ±‚æƒé™çº§åˆ«

## ç¯å¢ƒæ­å»º

åœ¨ windows ä¸‹ä½¿ç”¨è™šæ‹Ÿæœº vmwareï¼Œè™šæ‹Ÿæœºä½¿ç”¨ ubuntu 22.04 LTSï¼Œæ¨¡æ‹Ÿå™¨ä½¿ç”¨ qemuã€‚

æ­å»ºè™šæ‹Ÿæœº vmware è¿‡ç¨‹çœç•¥ï¼Œå…·ä½“çš„å¯æŸ¥çœ‹ [archlinux çš„æ­å»º](https://gonglja.github.io/posts/d78cdbc6/)

### æ­å»º ubuntu ä¸­ qemu

> ç”±äºä½¿ç”¨å‘½ä»¤ sudo apt install qemu å®‰è£…ç‰ˆæœ¬è¿‡æ—§å¹¶å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œæ‰€ä»¥æœ¬æ–‡ä½¿ç”¨ç¼–è¯‘æ–¹å¼å®‰è£…ã€‚

ubuntu å®¿ä¸»æœºç¯å¢ƒå¦‚ä¸‹ï¼š

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202205110934467.png)

### å®‰è£…ç¯å¢ƒå¿…å¤‡åŒ…

```shell
# 1. å®‰è£…ç¯å¢ƒå¿…å¤‡åŒ…
sudo apt-get install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev
sudo apt install ninja-build

# 2. ä¸‹è½½qemuæºç 
git clone https://mirrors.tuna.tsinghua.edu.cn/git/qemu.git

# 3. é…ç½®qemu
cd qemu
./configure
# å¦‚æœé…ç½®æ²¡æœ‰æŠ¥é”™ï¼Œåˆ™å¯ä»¥ç›´æ¥ç¼–è¯‘å¹¶å®‰è£…äº†ã€‚
# å¤§çº¦ 6376.73s ç¼–è¯‘å®Œæˆï¼Œå¯ä½¿ç”¨å‘½ä»¤ time make -j$(nproc) æŸ¥çœ‹æ—¶é—´ï¼Œä»¥ä¸‹ä¸ºæˆ‘æœ¬æ¬¡ç¼–è¯‘æ‰€éœ€æ—¶é—´
# make -j12  6376.73s user 729.92s system 1160% cpu 10:12.17 total
make -j$(nproc)

# ç›´æ¥./configure å¯èƒ½ä¼šæŠ¥é”™ï¼Œ./configure --with-git-submodules=validate é‡æ–°é…ç½®åç¼–è¯‘å®‰è£…å³å¯ã€‚
sudo make install -j$(nproc)

# 4.éªŒè¯ é€šè¿‡å‘½ä»¤å¯ä»¥çœ‹å‡º qemu çš„ç‰ˆæœ¬å·ï¼Œä»£è¡¨å®‰è£…å®Œæˆã€‚
u@u-virtual-machine /home/u/workspace/tools
âš¡ qemu-system-x86_64 --version
QEMU emulator version 7.0.50
Copyright (c) 2003-2022 Fabrice Bellard and the QEMU Project developers
```

é…ç½®å¥½åï¼Œæ‰“å¼€å‘ç°åªè¾“å‡ºä¸€å¥è¯ï¼ŒVNC Server runnning on 127.0.0.1:5900

è¿™æ˜¯å› ä¸ºæ²¡æœ‰æ”¯æŒ `SDL`(Simple DirectMedia Layer)

æ‰€ä»¥éœ€è¦é‡æ–°é…ç½®ååœ¨å®‰è£…ï¼Œ

```shell
# å®‰è£…SDLæ”¯æŒä¾èµ–
sudo apt install libsdl1.2-dev libsdl2-dev

# ç»§ç»­é…ç½®ï¼Œä¸€ä¼šæœç´¢ä¸€ä¸‹çœ‹ä¸‹SDLæ˜¯å¦ä¸ºYESï¼Œä¸ºYESåˆ™å·²ç»å¼€å¯äº†ï¼Œå‰©ä¸‹çš„ç›´æ¥ç¼–è¯‘å®‰è£…å°±å¯ã€‚
./configure --with-git-submodules=validate

# ç¼–è¯‘å’Œå®‰è£…
make -j$(nproc) && sudo make install -j$(nproc)

# å†æ¬¡éªŒè¯ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤åä¼šç›´æ¥å¼¹å‡ºqemuè™šæ‹Ÿæœº
qemu-system-x86_64
```

### é…ç½® gdb ç¯å¢ƒ

```shell
Â sudo apt install gdb
```

ä¹ æƒ¯ä½¿ç”¨ pwndbg äº†ï¼Œæ·»åŠ æ­¤æ’ä»¶ã€‚

## ä»£ç åˆ†æ

é¦–å…ˆä¸‹è½½æºç ï¼Œå¹¶ç¼–è¯‘ï¼Œæ²¡æœ‰é—®é¢˜é‚£ä¹ˆå°±å¼€å§‹åˆ†ææºç äº†ã€‚

### ä¸‹è½½æºç 

åœ°å€ä¸º [https://github.com/yuan-xy/Linux-0.11](https://github.com/yuan-xy/Linux-0.11)

ä¸è¿‡ä¹Ÿå¯ä»¥ fork åˆ°è‡ªå·±çš„ä»“åº“ä¸­ï¼Œæ–¹ä¾¿åé¢æ›´æ”¹åçš„ä¸Šä¼ ã€‚

```shell
git clone https://github.com/Gonglja/Linux-0.11.git && cd Linux-0.11
make clean -j$(nproc) && make -j$(nproc)
# ç›´æ¥å¯ä»¥ç¼–è¿‡ï¼Œä¸ä¼šç¼ºå°‘ä»€ä¹ˆåº“ã€‚
```

ä»£ç æ±‡ç¼–éƒ¨åˆ†é‡‡ç”¨ AT&T è¯­æ³•ï¼Œéœ€è¦ç†Ÿæ‚‰ AT&T

### æºç åˆ†æ

#### å¯„å­˜å™¨

TODO

#### è¿›å…¥å†…æ ¸å‰çš„è‹¦åŠ›æ´»

##### ç³»ç»Ÿä¸Šç”µåè·³è½¬åˆ°è‡³ bios

å½“ç³»ç»Ÿå¯åŠ¨æˆ–è€…é‡ç½®æ—¶ï¼Œå¤„ç†å™¨åœ¨å·²çŸ¥ä½ç½®æ‰§è¡Œä»£ç ã€‚åœ¨ç¬”è®°æœ¬ï¼ˆPCï¼‰ä¸­ï¼Œæ­¤ä½ç½®ä½äº BIOSï¼ˆBase input/output Systemï¼ŒåŸºæœ¬è¾“å…¥/è¾“å‡ºç³»ç»Ÿï¼‰ï¼Œè¯¥ç³»ç»Ÿå­˜å‚¨åœ¨ä¸»æ¿çš„ bios èŠ¯ç‰‡ä¸­ã€‚

å½“ç³»ç»Ÿå¯åŠ¨æˆ–é‡ç½®æ—¶ï¼Œå¤„ç†å™¨ä¼šé»˜è®¤è·³è½¬åˆ° bios ä¸­æ‰§è¡Œä»£ç ã€‚ä¸ºä»€ä¹ˆï¼Ÿ

é¦–å…ˆæˆ‘ä»¬è¦äº†è§£ CPU ä¸Šç”µåè¿è¡Œåœ¨å®æ¨¡å¼ä¸‹ï¼Œåœ¨å®æ¨¡å¼ä¸‹ CPU çš„å¯»å€åœ°å€ä¸º:$CS*4 + IP$ï¼Œè€Œä¸Šç”µå $CS$ é»˜è®¤å€¼ä¸º `0xffff`,$IP$ é»˜è®¤å€¼ä¸º `0x0000`ã€‚æ‰€ä»¥ä¸Šç”µå CPU ä¼šåˆ° $CS*16+IP=0xffff << 4 + 0x0 = 0xffff0$ å¤„æ‰§è¡Œç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚

ä½†åœ¨ 20 ä½åœ°å€ä¸‹ï¼Œæœ€å¤§è®¿é—®ç©ºé—´ä¹Ÿå°±æ˜¯ `1Mb`ï¼ˆ`0xfffff`ï¼‰ï¼Œæ­¤å¤„ä»…æœ‰ 16 å­—èŠ‚ï¼Œç©ºé—´å¤ªå°ä»¥è‡³äºæ— æ³•å­˜å‚¨ bios çš„ä»£ç ï¼Œæ‰€ä»¥ä¸€èˆ¬æ­¤å¤„éƒ½ä¸ºä¸€ä¸ªè·³è½¬æŒ‡ä»¤ã€‚è·³è½¬åˆ°çœŸæ­£çš„ bios å¤„æ‰§è¡Œä»£ç ã€‚

##### bios å®Œæˆåè·³è½¬ 0x7c00 å¤„

åœ¨ bios ä¸­ï¼Œé¦–å…ˆå®Œæˆ *POST*ï¼ˆPower On Self Testï¼Œä¸Šç”µè‡ªæ£€ï¼‰ï¼Œbios å¯¹è®¡ç®—æœºå„éƒ¨ä»¶è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœæœ‰é”™è¯¯åˆ™æŠ¥è­¦æç¤ºã€‚ä¸‹ä¸€æ­¥åœ¨å¤–éƒ¨å­˜å‚¨è®¾å¤‡ä¸­å¯»æ‰¾æ“ä½œç³»ç»Ÿï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯å¯åŠ¨è®¾å¤‡ã€‚å°†ç¬¬ä¸€ä¸ªå¯å¯åŠ¨å­˜å‚¨è®¾å¤‡ï¼ˆç¬¬ä¸€ä¸ªæ‰‡åŒºæœ€åä¸¤å­—èŠ‚ä¸º `0x55`ã€`0xaa`ï¼‰çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼ˆé¦– 512 å­—èŠ‚ï¼‰åŸå°ä¸åŠ¨çš„å¤åˆ¶åˆ° `0x7c00`ï¼Œç„¶åè·³è½¬åˆ° `0x7c00` å¤„ï¼Œå»æ‰§è¡Œç›¸åº”çš„ä»£ç ã€‚

![Pasted image 20221130104420.png](/img/user/Resources/Images/Pasted%20image%2020221130104420.png)

###### ç¬¬ä¸€æ‰‡åŒº

å…ˆçœ‹ä¸‹æœ€å¤–å±‚çš„ Makefileï¼Œå…³æ³¨å‡ ä¸ªç‚¹

```c
LDFLAGS += -Ttext 0 -e startup_32
```

å½“é“¾æ¥å™¨é“¾æ¥çš„æ—¶å€™ï¼Œå…¶å‚æ•°æºå¸¦ `-Ttext 0`ï¼ŒæŒ‡å®šä»£ç æ®µçš„è¿è¡Œåœ°å€ä» `0` å¼€å§‹

```c
all:	Image

Image: boot/bootsect boot/setup tools/system
	@cp -f tools/system system.tmp
	@$(STRIP) system.tmp
	@$(OBJCOPY) -O binary -R .note -R .comment system.tmp tools/kernel
	@tools/build.sh boot/bootsect boot/setup tools/kernel Image $(ROOT_DEV)
	@rm system.tmp
	@rm -f tools/kernel
	@sync

```

å¦ä¸€ä¸ªå°±æ˜¯ `all`ï¼Œ`all` ä¾èµ– Imageï¼Œ`Image` ä¾èµ– `boot/bootsect boot/setup tools/system` ç­‰ï¼Œç¼–è¯‘ç»“æŸååˆç»è¿‡ `tools/build.sh` è„šæœ¬æ„å»ºé•œåƒï¼Œé€šè¿‡è„šæœ¬å¯çŸ¥ç¬¬ä¸€ä¸ª 512 å­—èŠ‚å­˜çš„æ˜¯ bootsectï¼Œåé¢æ¥ç€ setup å’Œ systemï¼Œå…·ä½“å¯æŸ¥çœ‹è¡¨æ ¼ï¼ˆæ ¹æ® build.sh è„šæœ¬å¾—å‡ºï¼‰

```c
# Write bootsect (512 bytes, one sector) to stdout
[ ! -f "$bootsect" ] && echo "there is no bootsect binary file there" && exit -1
dd if=$bootsect bs=512 count=1 of=$IMAGE 2>&1 >/dev/null

# Write setup(4 * 512bytes, four sectors) to stdout
[ ! -f "$setup" ] && echo "there is no setup binary file there" && exit -1
dd if=$setup seek=1 bs=512 count=4 of=$IMAGE 2>&1 >/dev/null

# Write system(< SYS_SIZE) to stdout
[ ! -f "$system" ] && echo "there is no system binary file there" && exit -1
system_size=`wc -c $system |cut -d" " -f1`
[ $system_size -gt $SYS_SIZE ] && echo "the system binary is too big" && exit -1
dd if=$system seek=5 bs=512 count=$((2888-1-4)) of=$IMAGE 2>&1 >/dev/null
```

| æ¨¡å—                                  | åç§»é‡ï¼ˆæ®µ/Byteï¼‰| å¤§å°ï¼ˆæ®µ/Byteï¼‰| å¤‡æ³¨       |
| ------------------------------------- | ------------------- | ------------------------------------------------------- | ---------- |
| bootsect                              | 0/0                 | 1/512                                                   | å¯åŠ¨é˜¶æ®µ   |
| setup                                 | 1/512               | 4/2048                                                  | é…ç½®é˜¶æ®µ   |
| system                                | 5/2560              | (2888-1-4)\*512=1476096ï¼Œæœ€å¤§é•¿åº¦ï¼Œå®é™…ä¸º system çš„å¤§å° | å†…æ ¸ç­‰     |
| DEFAULT_MINOR_ROOT DEFAULT_MAJOR_ROOT | 0 æ®µä¸­çš„ç¬¬ 508 å­—èŠ‚ | 2                                                       | ç‰ˆæœ¬å·ä¿¡æ¯ |

ä¹Ÿç”±æ­¤å¯çŸ¥ï¼Œä¸Šç”µåä» bios è·³è½¬è¿‡æ¥åï¼Œç›´æ¥æ‰§è¡Œçš„æ˜¯ `bootsect` ä¸­çš„å†…å®¹ã€‚

###### è·³è½¬åˆ° 0x7c00

```shell
âœ  Linux-0.11 git:(master) tree boot
boot
â”œâ”€â”€ bootsect.s
â”œâ”€â”€ head.s
â”œâ”€â”€ Makefile
â””â”€â”€ setup.s

0 directories, 4 files
```

å…ˆçœ‹ä¸‹ `Makefile`ï¼Œé€šè¿‡ç¼–è¯‘è„šæœ¬å¯å¾— é“¾æ¥å™¨å‚æ•°ä¸º `-Ttext 0`ï¼Œå¦å¤–ä¸‰ä¸ª `bootsect`ã€`setup`ã€`head` æ¨¡å—ä¹Ÿæ˜¯åˆ†åˆ«ç¼–è¯‘ã€‚

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202204021631675.png)

**å½“ cpu ä¸Šç”µåï¼Œbios ä¼šå°†ç¬¬ä¸€ä¸ª==å¯å¯åŠ¨ç¡¬ç›˜==çš„å‰ 512 å­—èŠ‚æ•°æ®ï¼Œæ‹·è´åˆ° 0x7c00 å¤„ã€‚**

> [!tips] ä»€ä¹ˆå«å¯å¯åŠ¨è®¾å¤‡
> åªè¦ç¬¬ä¸€ä¸ªæ‰‡åŒºçš„ 512 å­—èŠ‚çš„æœ€åä¸¤å­—èŠ‚åˆ†åˆ«ä¸º 0x55ã€0xaaï¼Œé‚£ä¹ˆå…¶å°±æ˜¯ä¸€ä¸ªå¯å¯åŠ¨è®¾å¤‡ã€‚

å‰ 512 å­—èŠ‚æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ`bootsect` æ¨¡å—ï¼Œæ¢å¥è¯è¯´ï¼Œå½“ `cpu` ä¸Šç”µåï¼Œ`bios` å°† `bootsect` æ‹·è´åˆ° `0x7c00` å¤„ï¼Œå…¶å¤§å°ä¸º `512` Byteã€‚

ä¹‹åå°±è¿›å…¥åˆ° `0x7c00` å¤„ï¼Œå¼€å§‹æ‰§è¡Œ `bootsect` æ¨¡å—çš„ä»£ç ã€‚

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202204021638456.png)

##### æ‹·è´ç¬¬ä¸€ä¸ª 512 å­—èŠ‚åˆ° 0x90000 å¤„

`.global` å£°æ˜éƒ¨åˆ†æ ‡å·å¯¹å…¨å±€å¯è§ï¼Œ

- \_start ç¨‹åºå¼€å§‹çš„åœ°æ–¹
- begtext text æ®µå¼€å§‹çš„ä½ç½®
- begdata data æ®µå¼€å§‹çš„ä½ç½®
- begbss bss æ®µå¼€å§‹çš„ä½ç½®
- endtext text æ®µç»“æŸçš„ä½ç½®
- enddata data æ®µç»“æŸçš„ä½ç½®
- endbss bss æ®µç»“æŸçš„ä½ç½®

`.equ` è¡¨è¾¾å¼èµ‹å€¼æ“ä½œç¬¦

| æ ‡å· | å€¼ | å«ä¹‰ |
| -------- | -------------- | ----------------------- |
| SYSSIZE | 0x3000 (196kb) | system å¤§å° |
| SETUPLEN | 4 | setup æ®µä¸­é•¿åº¦ |
| BOOTSEG | 0x07c0 | boot æ®µæºåœ°å€ |
| INITSEG | 0x9000 | boot æ®µå³å°†ç§»åŠ¨åˆ°çš„ä½ç½® |
| SETUPSEG | 0x9020 | setup æ®µå¼€å§‹çš„ä½ç½® |
| SYSSEG | 0x1000 | system åŠ è½½çš„ä½ç½® 0x10000 |
| ENDSEG | SYSSEG+SYSSIZE | åœæ­¢åŠ è½½çš„ä½ç½® |

`ljmp $BOOTSEG, $_start` é•¿è·³è½¬ï¼Œè·³è½¬è‡³ $0x7c00 = BOOTSEG<<16 + \_start$ å¤„

```c
Â _start:
Â     mov $BOOTSEG, %ax Â  Â 
Â     mov %ax, %ds      #å°†dsæ®µå¯„å­˜å™¨è®¾ç½®ä¸º0x7C0
Â     mov $INITSEG, %ax
Â     mov %ax, %es      #å°†esæ®µå¯„å­˜å™¨è®¾ç½®ä¸º0x9000
Â     mov $256, %cx     #è®¾ç½®ç§»åŠ¨è®¡æ•°å€¼256å­—
Â     sub %si, %si     Â #æºåœ°å€ ds:si = 0x07C0:0x0000
Â     sub %di, %di     Â #ç›®æ ‡åœ°å€ es:si = 0x9000:0x0000
Â  Â  Â  Â  Â  rep Â  Â  Â  Â  Â #é‡å¤æ‰§è¡Œå¹¶é€’å‡cxçš„å€¼
Â     movsw Â  Â  Â  Â  Â  Â  #ä»å†…å­˜[si]å¤„ç§»åŠ¨cxä¸ªå­—åˆ°[di]å¤„
```

ç”±äºä¸èƒ½ç›´æ¥ç»™ ds èµ‹å€¼ï¼Œå€ŸåŠ© axï¼Œå°† ds å¯„å­˜å™¨å€¼è®¾ç½®ä¸º `0x7C0`ï¼›åŒç†ï¼Œå°† es æ®µå¯„å­˜å™¨è®¾ç½®ä¸º `0x900`ã€‚

æ¥ç€è®¾ç½® cx å¯„å­˜å™¨å€¼ä¸º `256`ï¼Œå°† siã€di å¯„å­˜å™¨æ¸…é›¶ã€‚

> **movsw**ï¼šæ•°æ®ä¼ é€æŒ‡ä»¤ï¼Œä»æºåœ°å€å‘ç›®çš„åœ°å€ä¼ é€æ•°æ®
> åœ¨ 16 ä½æ¨¡å¼ä¸‹ï¼Œæºåœ°å€ `DS:SI`ï¼Œç›®çš„åœ°å€ `ES:DI`
> åœ¨ 32 ä½æ¨¡å¼ä¸‹ï¼Œæºåœ°å€ `DS:ESI`ï¼Œç›®çš„åœ°å€ `ES:EDI`
> movsbã€movswã€movsd åŒºåˆ«ï¼Œb å­—èŠ‚ã€w å­—ã€d åŒå­—ï¼Œä¹Ÿå³ä¼ é€’ä¸€ä¸ªå­—èŠ‚ã€ä¸€ä¸ªå­—ã€ä¸€ä¸ªåŒå­—ã€‚

æ‰€ä»¥ï¼Œè¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯å°† `ds:si`(`0x7c0:0x0` å³ `0x7c00`) å¤„å¼€å§‹ï¼Œå¤§å°ä¸º `256å­—`ï¼Œå³ `512å­—èŠ‚` çš„æ•°æ®æ‹·è´åˆ° `es:di`(`0x9000:0x0` å³ `0x90000`) å¤„ã€‚

ä¹Ÿå°±æ˜¯ cpu ä¸Šç”µåï¼Œbios å°†ç¬¬ä¸€ä¸ªå¯å¯åŠ¨è®¾å¤‡çš„ç¬¬ä¸€ä¸ª `512å­—èŠ‚` å…ˆæ‹·è´åˆ° `0x7c00` å¤„ï¼Œæ¥ç€è·³è½¬åˆ° `0x7c00` å¤„æ‰§è¡Œï¼Œç„¶å 0x7c00 ä¸­çš„éƒ¨åˆ†ä»£ç åˆå°†è¯¥éƒ¨åˆ†ï¼ˆ`512å­—èŠ‚`ï¼‰æ‹·è´åˆ° `0x90000` å¤„

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091106175.png)

`ljmp $INITSEG, $go` é•¿è·³è½¬ï¼Œç›´æ¥è·³è½¬è‡³ `0x9000:go` å¤„ã€‚

##### è·³è½¬è‡³ 0x9c000 å¤„å¯¹å†…å­˜è¿›è¡Œåˆ†é…

æ¥ç€ï¼Œä¸€ä¸ªè¿œè·³ è·³è½¬è‡³ go å¤„ï¼Œç»§ç»­æ‰§è¡Œã€‚

> [!tips]
> çŸ­è·³ï¼šå¯è·³è‡³è·å½“å‰ä½ç½® 128 å­—èŠ‚å†…ä»¥å†…çš„èŒƒå›´ï¼ˆCS ä¸å˜ï¼Œ(E)IP å˜åŒ–ï¼‰
> è¿‘è·³ï¼šå¯è·³è½¬è‡³å½“å‰æ®µå†…çš„ä»»æ„ä½ç½®ï¼ˆCS ä¸å˜ï¼Œ(E)IP å˜åŒ–ï¼‰
> è¿œè·³ï¼šå¯è·³è½¬è‡³ä»»æ„ä½ç½®ï¼ˆCS å˜ï¼Œ(E)IP å˜ï¼‰

æ¥ç€æ‰§è¡Œ `go` å¤„çš„ä»£ç ã€‚ç”±äºæ˜¯é•¿è·³è½¬ï¼Œæ‰€ä»¥ cs çš„å€¼ä¸º `$INITSEG`ï¼Œä¹Ÿå°±æ˜¯ `0x9000`ã€‚

æ‰€ä»¥æ­¤å¤„ä»£ç ä¹Ÿå°±æ˜¯å°† `ds`ã€`es`ã€`ss` è®¾ç½®ä¸ºç§»åŠ¨åä»£ç æ‰€åœ¨çš„æ®µå¤„ï¼Œå¹¶ä¸”å°†å †æ ˆæ®µ è®¾ç½®ä¸º `0x9000:0` - `0x9000:0xff00`ï¼Œå³ `0x90000`- `0x9ff00`

```c
Â go:  mov Â  %cs, %ax #å°†dsï¼Œesï¼Œsséƒ½è®¾ç½®æˆç§»åŠ¨åä»£ç æ‰€åœ¨çš„æ®µå¤„(0x9000)
Â     mov %ax, %ds
Â     mov %ax, %es
Â     # put stack at 0x9ff00.
Â     mov %ax, %ss
Â     mov $0xFF00, %sp    # arbitrary value >>512
```

æ¥ç€é˜…è¯»ä¸‹é¢ä»£ç ï¼Œéƒ½æ˜¯ mov æ“ä½œï¼Œå°† ax çš„å€¼ç»™ dsã€es å’Œ ss å¯„å­˜å™¨ï¼Œè€Œ ax ç­‰äºå¤šå°‘å‘¢ï¼Ÿç”±ä¸Šä¸€æ¡è¿œè·³æŒ‡ä»¤å¯çŸ¥ï¼Œcs å¯„å­˜å™¨å€¼è¢«æ›´æ”¹ä¸º 0x9000ï¼Œæ‰€ä»¥ dsã€esã€ss å€¼å‡ä¸º 0x9000ã€‚

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204022109389.png)

ss ä¸ºæ ˆæ®µå¯„å­˜å™¨ï¼Œåé¢è¦é…åˆæ ˆåŸºå€å¯„å­˜å™¨ sp æ¥è¡¨ç¤ºæ­¤æ—¶çš„æ ˆé¡¶åœ°å€ã€‚è€Œæ­¤æ—¶ sp å¯„å­˜å™¨è¢«èµ‹ä¸º 0xFF00,æ‰€ä»¥ç›®å‰æ ˆé¡¶åœ°å€å°±æ˜¯ ss:ip æ‰€æŒ‡å‘çš„åœ°å€ 0x9FF00ã€‚

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204022115634.png)

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091424605.png)

##### å°†ç¡¬ç›˜å‰©ä½™éƒ¨åˆ†ä¹Ÿæ”¾åˆ°å†…å­˜ä¸­

```c
Â load_setup:
Â     mov $0x0000, %dx    # drive 0, head 0
Â     mov $0x0002, %cx    # sector 2, track 0
Â     mov $0x0200, %bx    # address = 512, in INITSEG
Â     .equ Â  Â AX, 0x0200+SETUPLEN
Â     mov Â  Â  $AX, %ax    # service 2, nr of sectors
Â     int $0x13    Â  Â  Â  Â # read it
```

çœ‹ä¸€ä¸‹ `int $13`ï¼ŒBIOS int 13h ä¸­æ–­ä¹Ÿå«ç›´æ¥ç£ç›˜æœåŠ¡ï¼ˆDirect Disk Serviceï¼‰å…¶å¯¹åº”ã€‚

> æ­¤å¤„ int ä¸ºä¸­æ–­ï¼Œ`int 0x13`ï¼Œå‘èµ· `0x13` å·ä¸­æ–­ã€‚
> å½“ä¸­æ–­å‘ç”Ÿåï¼ŒBIOS ä¼šæ ¹æ®ä¸­æ–­ç¼–å·å»æ‰¾å¯¹åº”çš„ä¸­æ–­å‡½æ•°å…¥å£åœ°å€å¹¶è·³è½¬è¿‡å»æ‰§è¡Œï¼Œç›¸å½“äºæ­¤å¤„æ‰§è¡Œäº†ä¸€ä¸ªå‡½æ•°ã€‚

- ax=0x0204 å…¶åŠŸèƒ½æè¿°ä¸ºè¯»æ‰‡åŒºï¼Œæ‰‡åŒºæ•°ä¸º 4
- bx=0x0200 å…¶åŠŸèƒ½é…ç½® es å¯„å­˜å™¨ç»„æˆç¼“å†²åŒºåœ°å€ï¼Œes:bx ç¼“å†²åŒºåœ°å€
- cx=0x0002 åˆ†ä¸º ch å’Œ clï¼Œch æŸ±é¢ï¼Œcl æ‰‡åŒºã€‚å³ 0 æŸ±é¢ 2 æ‰‡åŒºã€‚
- dx=0x0000 åˆ†ä¸º dh å’Œ dlï¼Œdh ç£å¤´ï¼Œdl é©±åŠ¨å™¨ 00H~7FH è½¯ç›˜ï¼›80H~FFH ç¡¬ç›˜

ä¹Ÿå°±æ˜¯ä» `è½¯ç›˜é©±åŠ¨å™¨0` çš„ `0æŸ±é¢2æ‰‡åŒº` å¼€å§‹ï¼Œæ‹·è´ `4æ‰‡åŒº` åˆ° `es:bx`ï¼Œä¹Ÿå°±æ˜¯ `0x9000:0x0200` å³ `0x90200`

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091342057.png)

æ‹·è´çš„æ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿç¡¬ç›˜ä¸­ 1-5 æ‰‡åŒº å…± 4 æ‰‡åŒºçš„ä»£ç ã€‚

```c
load_setup:
	...
	jnc	ok_load_setup		# ok - continue
	mov	$0x0000, %dx
	mov	$0x0000, %ax		# reset the diskette
	int	$0x13
	jmp	load_setup
```

æ¥ç€ å› ä¸º `AX>=0`ï¼Œè·³è½¬åˆ° `ok_load_setup` æ‰§è¡Œã€‚

```c
ok_load_setup:
	...
	mov	$SYSSEG, %ax
	mov	%ax, %es		# segment of 0x010000
	call    read_it
	...
	ljmp	$SETUPSEG, $0
```

è¿™éƒ¨åˆ†åªçœ‹ä¸»è¦ä»£ç ï¼Œå…¶å°†å‰©ä¸‹çš„ä»ç¬¬ 6 ä¸ªæ‰‡åŒºåé¢çš„ x ä¸ªæ‰‡åŒºï¼ŒåŠ è½½åˆ°å†…å­˜ `0x10000` å¤„ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°† system ä»£ç æŒªäº†ä¸ªåœ°ã€‚

æ¥ç€ä¸€ä¸ªé•¿è·³è½¬ `SETUPSEG`ï¼Œå°† CS è®¾ç½®ä¸º `0x9020`ï¼ŒEIP è®¾ç½®ä¸º `0x0` ä¹Ÿå°±æ˜¯è·³è½¬åˆ° `0x9020<<16 | 0` å³ `0x90200`

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091422374.png)

ç¡¬ç›˜ä¸­æ•°æ®æ˜¯æ€ä¹ˆåˆ†åŒºçš„å‘¢

é€šè¿‡ `Makefile` å’Œ `tools/build.sh` é…åˆå®Œæˆï¼Œå…¶ä¸­

- `bootsect.s` ç¼–è¯‘æˆ bootsectï¼Œæ”¾åœ¨ç¬¬ `1` æ‰‡åŒº
- `setup.s` ç¼–è¯‘æˆ `setup`ï¼Œæ”¾åœ¨ `2~5` æ‰‡åŒº
- å°†å‰©ä¸‹çš„ `head.s` å’Œå…¶ä»–ä»£ç ç¼–è¯‘æˆ `system`ï¼Œæ”¾åœ¨éšåçš„ 240 ä¸ªæ‰‡åŒºï¼Ÿï¼ˆä¸ä¸€å®šæ˜¯ 240 æ‰‡åŒºï¼‰
  ![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202204022233895.png)

**æ€»ç»“ä¸€ä¸‹ï¼š

cpu ä¸Šç”µå bios å°†ç¬¬ä¸€ä¸ªå¯å¯åŠ¨åˆ†åŒºçš„å‰ 512 å­—èŠ‚ (bootsect) æ‹·è´åˆ° 0x7c00 å¤„ï¼Œå¹¶è·³è½¬è¿‡å»æ‰§è¡Œï¼Œæ¥ç€ bootsect åˆæŠŠè‡ªå·±æ¬åˆ°äº† 0x90000 å¤„ã€‚

ç„¶åè·³è½¬è¿‡å»ï¼Œå°† 2 æ‰‡åŒº -5 æ‰‡åŒºï¼ˆsetupï¼‰å…± 4 æ‰‡åŒºæ‹·è´åˆ° 0x90200 å¤„ã€‚æ¥ç€å°† 6 æ‰‡åŒºä»¥åï¼ˆsystemï¼‰æ‹·è´åˆ° 0x10000 å¤„ã€‚æœ€åè·³è½¬åˆ° `0x90200` å¤„æ‰§è¡Œ**ã€‚

> åœ¨åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å€ŸåŠ© `gdb`ï¼Œ`target remote :1234`ï¼Œ
> b \*0x7c00 åœ¨ 0x7c00 å¤„åŠ ä¸ªæ–­ç‚¹
> b \*0x90200 åœ¨ 0x90200 å¤„åŠ ä¸ªæ–­ç‚¹
> å½“è·³è½¬åˆ° 0x90200 å¤„ï¼Œé€šè¿‡å‘½ä»¤ `x/512b 0x90200`,`x/256h 0x90200` å¤„å€¼ï¼Œå‘ç°å°±æ˜¯æˆ‘ä»¬æ‹·è´è¿‡å»çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼ˆbootsectï¼‰
> ![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206061437146.png)

##### setup è·å–ç³»ç»Ÿæ•°æ®ã€ä¿®æ”¹å†…å­˜å¸ƒå±€

setup.s è´Ÿè´£ä» BIOS ä¸­è·å–ç³»ç»Ÿæ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®æ”¾åˆ°ç³»ç»Ÿå†…å­˜çš„åˆé€‚åœ°æ–¹ã€‚è¿™æ®µä»£ç è¯¢é—® bios æœ‰å…³å†…å­˜/ç£ç›˜/å…¶å®ƒå‚æ•°ï¼Œå¹¶å°†è¿™äº›å‚æ•°å­˜åˆ°ä¸€ä¸ªâ€œå®‰å…¨çš„â€åœ°æ–¹ï¼š0x90000-0x901FFã€‚

```c
.equ SETUPSEG, 0x9020 # this is the current segment
...
ljmp $SETUPSEG, $_start
_start:
 mov %cs,%ax
 mov %ax,%ds
 mov %ax,%es
```

è·³è½¬åˆ°ç›¸å¯¹äº `0x90200` å¤„åç§» `_start` çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å½“å‰ `_start` ä»£ç çš„ä½ç½®ï¼Œæ›´æ–°å½“å‰ dsã€es å¯„å­˜å™¨å€¼ä¸º `0x9020`ã€‚

æ¥ç€å¾€ä¸‹çœ‹ä»£ç ï¼Œéƒ½æ˜¯å½¢ä¼¼ `mov %ax,$xxa;mov %bx,$xxb;mov %cx,$xxc;mov %dx,$xxd;int xxe;` éƒ½æ˜¯é€šè¿‡ bios ä¸­æ–­è·å–ä¿¡æ¯ï¼Œç„¶åå°†å…¶å­˜åœ¨å†…å­˜ä¸­ã€‚

å­˜åœ¨å“ªå‘¢ï¼Ÿå®é™…ä¸Šæ˜¯ä¿å­˜åœ¨ ds å¯„å­˜å™¨å€¼ä¸º éƒ½ä¸º cs å¯„å­˜å™¨çš„å€¼ï¼Œåç§»ä¸º 0 å¤„ï¼ˆ`cs:0 = cs<<16+0`ï¼‰ã€‚

```c
ljmp $SETUPSEG, $_start
_start:
 mov %cs,%ax
 mov %ax,%ds
 ...
 int $0x10 # save it in known place, con_init fetches
 mov %dx, %ds:0 # it from 0x90000.
```

æœ€ç»ˆä¼šé€šè¿‡ bios è·å–åˆ°è¿™äº›æ•°æ®ï¼Œå°†ä¹‹å­˜åˆ°èµ·å§‹ä¸º 0x90000 çš„ä½ç½®ã€‚

| å†…å­˜åœ°å€ | é•¿åº¦ (å­—èŠ‚) | åç§°          |
| -------- | ---------- | ------------- |
| 0x90000  | 2          | å…‰æ ‡ä½ç½®      |
| 0x90002  | 2          | æ‰©å±•å†…å­˜æ•°    |
| 0x90004  | 2          | æ˜¾ç¤ºé¡µé¢      |
| 0x90006  | 1          | æ˜¾ç¤ºæ¨¡å¼      |
| 0x90007  | 1          | å­—ç¬¦åˆ—æ•°      |
| 0x90008  | 2          | æœªçŸ¥          |
| 0x9000A  | 1          | æ˜¾ç¤ºå†…å­˜      |
| 0x9000B  | 1          | æ˜¾ç¤ºçŠ¶æ€      |
| 0x9000C  | 2          | æ˜¾å¡ç‰¹æ€§å‚æ•°  |
| 0x9000E  | 1          | å±å¹•è¡Œæ•°      |
| 0x9000F  | 1          | å±å¹•åˆ—æ•°      |
| 0x90080  | 16         | ç¡¬ç›˜ 1 å‚æ•°è¡¨ |
| 0x90090  | 16         | ç¡¬ç›˜ 2 å‚æ•°è¡¨ |
| 0x901FC  | 2          | æ ¹è®¾å¤‡å·      |

å°†ä»¥ä¸Šä¿¡æ¯å­˜å‚¨åˆ° 0x90000 å¤„åï¼Œå°†å…³é—­ä¸­æ–­ã€‚å› ä¸ºåé¢æˆ‘ä»¬è¦è‡ªå·±å®ç°ä¸­æ–­ï¼Œå¹¶ä¸”å°† bios çš„ä¸­æ–­å‘é‡è¡¨ç ´åæ‰ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™æ˜¯ä¸å…è®¸ä¸­æ–­è¿›æ¥çš„ã€‚

```c
  ...
  cli
  ...
```

çœ‹ä¸‹é¢çš„éƒ¨åˆ†ï¼Œæ˜¯ä¸å¾ˆç†Ÿæ‚‰ `movsw`ï¼Œæ˜¯ä¸€ä¸ªæ•°æ®ä¼ é€æŒ‡ä»¤ï¼Œå°†ä¸€æ®µæ•°æ®ä»æºåœ°å€ä¼ é€åˆ°ç›®çš„åœ°å€ï¼Œè¯¦è§ [æŒ‡ä»¤](#%E6%8C%87%E4%BB%A4)ã€‚

```c
	mov	$0x0000, %ax
	cld			# 'direction'=0, movs moves forward
do_move:
	mov	%ax, %es	# destination segment
	add	$0x1000, %ax
	cmp	$0x9000, %ax
	jz	end_move
	mov	%ax, %ds	# source segment
	sub	%di, %di
	sub	%si, %si
	mov 	$0x8000, %cx
	rep
	movsw
	jmp	do_move
```

è¿™æ®µä»£ç ï¼Œä¹Ÿå°±æ˜¯å°† system æ¨¡å—ç§»åŠ¨åˆ°æ–°çš„ä½ç½®ï¼Œæ–°ä½ç½®èµ·å§‹ä¸º 0ã€‚

ä¸ä»¥ä¸‹ c ä»£ç ç›¸åŒã€‚

```c
char add[0x90000];
int j=0;
for(int i=0x10000; i<0x90000;i++){
	add[j++] = add[i];
}
```

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091459373.png)

é‡æ–°è§„åˆ’åå†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼Œ

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091501381.png)

#### å®æ¨¡å¼åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼ (åˆ†æ®µæœºåˆ¶)

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202204041906123.png)

å®æ¨¡å¼ä¸ä¿æŠ¤æ¨¡å¼çš„ç¬¬ä¸€ä¸ªåŒºåˆ«ï¼šç‰©ç†åœ°å€è®¡ç®—æ–¹å¼ä¸åŒ

å®æ¨¡å¼ä¸‹ï¼š$ç‰©ç†åœ°å€ = æ®µå¯„å­˜å™¨ä¸­çš„åœ°å€<<16 + åç§»åœ°å€$ã€‚

ä¿æŠ¤æ¨¡å¼ä¸‹ï¼šæ®µå¯„å­˜å™¨ä¸­ å­˜çš„æ˜¯æ®µé€‰æ‹©å­ï¼Œæ®µé€‰æ‹©å­å»å…¨å±€æè¿°ç¬¦ä¸­å¯»æ‰¾æ®µé€‰æ‹©ç¬¦ï¼Œä»ä¸­å–å‡ºæ®µåŸºåœ°å€ å†åŠ ä¸Šåç§»åœ°å€æ‰æ˜¯ç‰©ç†åœ°å€ã€‚

> â€œè®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³â€ã€‚
> "Any problem in computer science can be solved by anther layer of indirection."

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206061651461.png)

é‚£ä¹ˆæ˜¯å¦‚ä½•ä»å®æ¨¡å¼ï¼ˆ16 ä½ï¼‰åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼ï¼ˆ32 ä½ï¼‰çš„å‘¢ï¼Ÿ

[LGDT/LIDT](https://www.felixcloutier.com/x86/lgdt:lidt) æ ¹æ®æ“ä½œæ•°çš„å€¼å¤§å°ç¡®å®š LGDT/LIDT å¯„å­˜å™¨çš„ç»“æ„

> åœ¨ 16 ä½æ“ä½œæ•°ä¸‹ï¼šIDTR(Limit) <- SRC[0:15],IDTR(Base) <- SRC[16:47] & 00FFFFFFH;
>
> åœ¨ 32 ä½æ“ä½œæ•°ä¸‹ï¼šIDTR(Limit) <- SRC[0:15],IDTR(Base) <- SRC[16:47];
>
> åœ¨ 64 ä½æ“ä½œæ•°ä¸‹ï¼šIDTR(Limit) <- SRC[0:15],IDTR(Base) <- SRC[16:79];
>
> é‚£ä¹ˆ IDTR å¯„å­˜å™¨æ˜¯å¤šä¹ˆå¤§çš„å‘¢ï¼Ÿ

```c
lidt	[idt_48]		; load idt with 0,0
lgdt	[gdt_48]		; load gdt with whatever appropriate
```

`lidt [idt_48]` æ±‡ç¼–æŒ‡ä»¤å°† `idt_48` å¤„çš„ **48** å­—èŠ‚åŠ è½½è‡³ ldtr å¯„å­˜å™¨ä¸­

`lgdt [gdt_48]` æ±‡ç¼–æŒ‡ä»¤å°† `gdt_48` å¤„çš„ **48** å­—èŠ‚åŠ è½½è‡³ lgtr å¯„å­˜å™¨ä¸­

```c
idt_48:
	dw	0			; idt limit=0
	dw	0,0			; idt base=0L

gdt_48:
    dw	0x800		; gdt limit=2048, 256 GDT entries
    dw	512+gdt,0x9	; gdt base = 0X9xxxx  0x9 << 32 + (512 +gdt(gdtä¸ºåœ¨æ­¤æ–‡ä»¶ä¸­çš„åç§»))

```

gdtr å¯„å­˜å™¨ç»“æ„

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204040902532.png)

gdt å¤„ä¾¿ä¸ºå…¨å±€æè¿°ç¬¦åœ¨å†…å­˜ä¸­çš„ä½ç½®äº†ï¼Œå¯ä»¥çœ‹å‡ºï¼Œä¸€å…±æœ‰ä¸‰æ®µï¼Œç¬¬ä¸€æ®µä¸º dummyï¼Œç¬¬äºŒæ®µä¸ºä»£ç æ®µæè¿°ç¬¦ï¼ˆå¯è¯»å¯æ‰§è¡Œï¼‰ï¼Œç¬¬ä¸‰æ®µä¸ºæ•°æ®æ®µæè¿°ç¬¦ï¼ˆå¯è¯»å¯å†™ï¼‰

```c
gdt:
	dw	0,0,0,0		; dummy

	dw	0x07FF		; 8Mb - limit=2047 (2048*4096=8Mb)
	dw	0x0000		; base address=0
	dw	0x9A00		; code read/exec
	dw	0x00C0		; granularity=4096, 386

DATA_DESCRIPTOR:
	dw	0x07FF		; 8Mb - limit=2047 (2048*4096=8Mb)
	dw	0x0000		; base address=0
	dw	0x9200		; data read/write
	dw	0x00C0		; granularity=4096, 386
```

å…¶ä¸­ä¸€ä¸ªæè¿°ç¬¦çš„æ ¼å¼å¦‚ä¸‹ï¼Œæ ¹æ®æ®µæè¿°ç¬¦ç»“æ„æˆ‘ä»¬å¯ä»¥çœ‹å‡ºä¸‰ä¸ªæ®µåŸºå€å‡ä¸º 0

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204040913252.png)

å†…å­˜ä¸­çš„åˆ†å¸ƒå¦‚ä¸‹ï¼š

- æ ˆé¡¶åœ°å€ 0x9ff00
- ç¡¬ç›˜çš„ç¬¬ 2-5 ä¸ªæ‰‡åŒºåœ¨ 0x90200 å¤„ï¼Œå…¶ä¸­ gdt å’Œ idt æ”¾åœ¨ 0x90200 å¼€å§‹çš„æŸä¸€ä¸ªåœ°æ–¹ï¼Œåœ°å€ï¼ˆ0x90200 + gdt/idt åç§»ï¼‰å­˜å‚¨åœ¨ gdtr/idtr å¯„å­˜å™¨ä¸­
- 0x90000 å­˜æ”¾çš„æ˜¯ä» bios ä¸­è¯»å–çš„ä¸´æ—¶å­˜æ”¾çš„å˜é‡
- 0x0~0x80000 å­˜æ”¾çš„æ˜¯æ“ä½œç³»ç»Ÿçš„å…¨éƒ¨ä»£ç 

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091544587.png)

åé¢ **å´æ¢åˆ°ä¿æŠ¤æ¨¡å¼åï¼Œæ®µå¯„å­˜å™¨ï¼ˆcs,ds,ssï¼‰ä¸­å­˜å‚¨çš„æ˜¯æ®µé€‰æ‹©å­ï¼Œæ®µé€‰æ‹©å­å»å…¨å±€æè¿°ç¬¦ä¸­å¯»æ‰¾æ®µæè¿°ç¬¦ï¼Œä»ä¸­å–å‡ºæ®µåŸºå€**

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204040934036.png)

```c
    mov	al,0xD1		; command write
    out	0x64,al

    mov	al,0xDF		; A20 on
    out	0x60,al
```

è¿™æ®µä»£ç çš„æ„æ€æ˜¯æ‰“å¼€ A20 åœ°å€çº¿ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä»€ä¹ˆæ˜¯ A20 åœ°å€çº¿ï¼Ÿä¸ºä»€ä¹ˆè¦å¼€ï¼Ÿ

A20 åœ°å€çº¿æ˜¯ä¸ºäº†çªç ´ 20 ä½åœ°å€çº¿çš„é™åˆ¶ï¼Œå˜æˆ 32 ä½å¯ç”¨ï¼Œæ‰€ä»¥å³ä½¿åœ°å€çº¿æœ‰ 32 ä½äº†ï¼Œä½†æ˜¯ä½ å¦‚æœä¸æ‰‹åŠ¨å¼€å¯ï¼Œè¿˜æ˜¯ä¼šé™åˆ¶ 20 ä½å¯ç”¨ã€‚ç°åœ¨çš„ CPU ä½æ•°éƒ½ 32 ä½ã€64 ä½ï¼Œä¸ºäº†å…¼å®¹ä»¥å‰çš„ 20 ä½åœ°å€æ€»çº¿ï¼Œä¾¿æœ‰äº†æ­¤é€‰é¡¹ã€‚

æ¥ç€å¾€ä¸‹èµ°ï¼Œè¿™ä¸€å †ä»£ç æ˜¯ **å¯¹å¯å˜æˆä¸­æ–­æ§åˆ¶å™¨ 8259 èŠ¯ç‰‡çš„ç¼–ç¨‹**ã€‚

```c
	mov	al,0x11		; initialization sequence
	out	0x20,al		; send it to 8259A-1
	dw	0x00eb,0x00eb		; jmp $+2, jmp $+2
	out	0xA0,al		; and to 8259A-2
	dw	0x00eb,0x00eb
	mov	al,0x20		; start of hardware int's (0x20)
	out	0x21,al
	dw	0x00eb,0x00eb
	mov	al,0x28		; start of hardware int's 2 (0x28)
	out	0xA1,al
	dw	0x00eb,0x00eb
	mov	al,0x04		; 8259-1 is master
	out	0x21,al
	dw	0x00eb,0x00eb
	mov	al,0x02		; 8259-2 is slave
	out	0xA1,al
	dw	0x00eb,0x00eb
	mov	al,0x01		; 8086 mode for both
	out	0x21,al
	dw	0x00eb,0x00eb
	out	0xA1,al
	dw	0x00eb,0x00eb
	mov	al,0xFF		; mask off all interrupts for now
	out	0x21,al
	dw	0x00eb,0x00eb
	out	0xA1,al
```

åœ¨å¯¹ 8259 èŠ¯ç‰‡é‡æ–°ç¼–ç¨‹åï¼ŒPIC è¯·æ±‚å·å’Œä¸­æ–­å·çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š

| PIC è¯·æ±‚å· | ä¸­æ–­å· |     ç”¨é€”     |
| :--------: | :----: | :----------: |
|    IRQ0    |  0x20  |   æ—¶é’Ÿä¸­æ–­   |
|    IRQ1    |  0x21  |   é”®ç›˜ä¸­æ–­   |
|    IRQ2    |  0x22  |  æ¥è¿ä»èŠ¯ç‰‡  |
|    IRQ3    |  0x23  |    ä¸²å£ 2    |
|    IRQ4    |  0x24  |    ä¸²å£ 1    |
|    IRQ5    |  0x25  |    å¹¶å£ 2    |
|    IRQ6    |  0x26  |  è½¯ç›˜é©±åŠ¨å™¨  |
|    IRQ7    |  0x27  |    å¹¶å£ 1    |
|    IRQ8    |  0x28  |  å®æ—¶é’Ÿä¸­æ–­  |
|    IRQ9    |  0x29  |     ä¿ç•™     |
|   IRQ10    |  0x2a  |     ä¿ç•™     |
|   IRQ11    |  0x2b  |     ä¿ç•™     |
|   IRQ12    |  0x2c  |   é¼ æ ‡ä¸­æ–­   |
|   IRQ13    |  0x2d  | æ•°å­¦åå¤„ç†å™¨ |
|   IRQ14    |  0x2e  |   ç¡¬ç›˜ä¸­æ–­   |
|   IRQ15    |  0x2f  |     ä¿ç•™     |

```c
	mov	ax,0x0001	; protected mode (PE) bit
	lmsw	ax		; This is it;
	jmp	8:0			; jmp offset 0 of segment 8 (cs)
```

å‰ä¸¤è¡Œï¼Œå°† cr0 è¿™ä¸ªå¯„å­˜å™¨çš„ä½ 0 ç½® 1ï¼Œæ¨¡å¼å°±ä»æ˜¯æ¨¡å¼åˆ‡æ¢åˆ°ä¿æŠ¤æ¨¡å¼äº†ã€‚

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204040953220.png)

ç»§ç»­ï¼Œåé¢ä¸€ä¸ªè¿œè·³ï¼Œæ“ä½œæ•°ä¸º **8:0**

åœ¨ä¸Šé¢ä¸¤è¡Œä»£ç ç»“æŸåï¼Œæ­¤æ—¶å·²ç»æ˜¯ä¿æŠ¤æ¨¡å¼äº†ï¼Œä¿æŠ¤æ¨¡å¼ä¸‹å¯»å€æ–¹å¼å˜äº†ï¼Œæ®µå¯„å­˜å™¨ä¸­çš„å€¼ä¸ºæ®µé€‰æ‹©å­ï¼Œæ®µé€‰æ‹©çš„ç»“æ„å¦‚ä¸‹ ![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204040957062.png)

0x8ï¼ŒäºŒè¿›åˆ¶ 1000ï¼Œå¯¹åº”ç€ æè¿°ç¬¦çš„ç´¢å¼•ä¸º 1ï¼Œä¹Ÿå°±æ˜¯å»å…¨å±€æè¿°ç¬¦ gdt ä¸­æ‰¾ç´¢å¼•ä¸º 1 çš„æ®µæè¿°ç¬¦ã€‚ä½†æ˜¯å‘¢ï¼Œåœ¨å‰é¢æˆ‘ä»¬åˆ†æè¿‡ï¼Œå…¨å±€æè¿°ç¬¦ä¸­çš„æœ‰ä¸‰é¡¹ï¼Œç¬¬ä¸€é¡¹éƒ½ä¸º 0ï¼Œç¬¬äºŒä¸‰é¡¹æ®µåŸºå€éƒ½ä¸º 0ï¼Œæ‰€ä»¥æ®µåŸºå€ä¸º 0ï¼Œåç§»ä¹Ÿæ˜¯ 0ï¼Œæ‰€ä»¥è¿™ä¸ªè·³è½¬æŒ‡ä»¤ï¼Œ**å°±æ˜¯è·³è½¬åˆ°å†…å­˜åœ°å€çš„ 0 åœ°å€å¤„**ã€‚

0 åœ°å€å¤„å­˜æ”¾çš„æ˜¯æˆ‘ä»¬ system è¿™ä¸ªå¤§æ¨¡å—ï¼Œè€Œ system è¿™ä¸ªæ¨¡å—ç”± head.sã€main.c åŠå…¶ä½™æ¨¡å—çš„æ“ä½œç³»ç»Ÿä»£ç åˆå¹¶æ¥çš„ï¼ˆå¦‚ä½•çŸ¥é“çš„ï¼ŒæŸ¥çœ‹ Makefile ä¸­ tools/system å¯çœ‹åˆ°ç”± head.o å’Œ main.o è¿˜æœ‰å…¶ä½™æ¨¡å—ç»„æˆï¼‰ã€‚

##### åˆ†æ®µä¸åˆ†é¡µ

å…ˆæ¥ä¸€ä¸ªç²¾é«“ï¼Œå¼€å¯åˆ†æ®µæœºåˆ¶å’Œåˆ†é¡µæœºåˆ¶å

é€»è¾‘åœ°å€ç”± **æ®µé€‰æ‹©å­** å’Œ **æ®µå†…åç§»** ç»„æˆï¼Œæ ¹æ®æ®µé€‰æ‹©å­åœ¨ GDT ä¸­æ‰¾åˆ°æ®µåŸºå€ï¼Œç±»ä¼¼äºæ•°ç»„ `a[b]=c`ï¼Œa å°±æ˜¯å…¨å±€æè¿°ç¬¦è¡¨ GDTï¼Œb å°±æ˜¯æ®µé€‰æ‹©å­ï¼Œc å°±æ˜¯æ®µåŸºå€

çº¿æ€§åœ°å€ç”± ä¸Šæ–‡äº§ç”Ÿçš„ æ®µåŸºå€ + æ®µå†…åç§» ç»„æˆã€‚

çº¿æ€§åœ°å€åˆåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šé¡µç›®å½•é¡¹ã€é¡µè¡¨é¡¹ã€é¡µå†…åç§»

æ ¹æ® **é¡µç›®å½•é¡¹** åœ¨ **é¡µç›®å½•è¡¨** ä¸­æ‰¾å‡º **é¡µè¡¨**

æ ¹æ® **é¡µè¡¨é¡¹** åœ¨ **é¡µè¡¨** ä¸­æ‰¾å‡º **é¡µ**

åœ¨åŠ ä¸Š **é¡µå†…åç§»** å°±æ˜¯å®é™…çš„ç‰©ç†åœ°å€

![Pasted image 20221206194827.png](/img/user/Resources/Images/Pasted%20image%2020221206194827.png)

ç”±æœ€å¤–å±‚çš„ Makefile å¯å¾—ï¼Œsystem ç”± `boot/head.o`ã€`init/main.o` åŠå…¶å®ƒç»„æˆï¼Œå¹¶ä¸” system åœ¨ bootsect ä¸­è¢«æ¬è¿è‡³ 0 å¤„ã€‚æ‰€ä»¥åœ¨ setup ä¸­è·³è½¬åˆ° 0 å¤„ï¼Œä¹Ÿå°±æ˜¯è·³è½¬åˆ° head ä¸­äº†ã€‚

æ¥ç€å°±å¼€å§‹ç ”ç©¶ head.s äº†ã€‚æ­¤å¤„æ±‡ç¼–é£æ ¼å˜ä¸º AT&T

```c
pg_dir:
.globl startup_32
startup_32:
 movl $0x10,%eax
 mov %ax,%ds
 mov %ax,%es
 mov %ax,%fs
 mov %ax,%gs
 lss stack_start,%esp
 call setup_idt
 call setup_gdt
 movl $0x10,%eax # reload all the segment registers
 mov %ax,%ds # after changing gdt. CS was already
 mov %ax,%es # reloaded in 'setup_gdt'
 mov %ax,%fs
 mov %ax,%gs
 lss stack_start,%esp
```

çœ‹ä¸‹ä»£ç ï¼Œåˆšå¼€å§‹æœ‰ä¸ªæ ‡å· `pg_dir`ï¼Œè¿™ä¸ªæ˜¯é¡µç›®å½•ï¼Œä¹‹åè®¾ç½®åˆ†é¡µæœºåˆ¶çš„æ—¶å€™ï¼Œé¡µç›®å½•ä¼šæ”¾è¿™ï¼Œè¦†ç›–è¿™é‡Œå¾—ä»£ç ã€‚

å¾€ä¸‹èµ°ï¼Œå°±æ˜¯ç»™ eax èµ‹å€¼ä¸º 0x10ï¼Œç»™ dsã€esã€fsã€gs èµ‹å€¼ 0x10(0b0001_0000)ï¼Œä¹Ÿå°±æ˜¯ 0b0001_0 å³ 2ï¼Œç´¢å¼•ä¸º 2 çš„æ®µä¸ºæ•°æ®æ®µã€‚

ç„¶å `lss stack_start,%esp`ï¼Œå°† `stack_start` é«˜ä½ç»™ ssï¼Œä½ 16 ä½ç»™ espã€‚ï¼ˆä¹‹å‰æ˜¯ 0x9ff00ï¼Œç°åœ¨è¦æ¢åˆ°\_stack_startï¼‰

stack_start è¿™ä¸ªæ ‡å·åœ¨ sched.c ä¸­ï¼Œï¼ˆå…³äºä¸ºä»€ä¹ˆæ˜¯ start_start è€Œä¸æ˜¯\_stack_start è¿™ä¸ªæ˜¯å› ä¸º [cdecl è°ƒç”¨è§„çº¦ä¸­ç¬¬ 4 æ¡:**ç¼–è¯‘åçš„å‡½æ•°åå‰ç¼€ä»¥ä¸€ä¸ªä¸‹åˆ’çº¿å­—ç¬¦å¼€å§‹**](https://zh.wikipedia.org/wiki/X86%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A#:~:text=%E5%AF%84%E5%AD%98%E5%99%A8ST0%E4%B8%AD-,%E7%BC%96%E8%AF%91%E5%90%8E%E7%9A%84%E5%87%BD%E6%95%B0%E5%90%8D%E5%89%8D%E7%BC%80%E4%BB%A5%E4%B8%80%E4%B8%AA%E4%B8%8B%E5%88%92%E7%BA%BF%E5%AD%97%E7%AC%A6,-%E8%B0%83%E7%94%A8%E8%80%85)ï¼‰

```c
long user_stack[4096>>2];

struct {
 long *a;
 short b;
} stack_start = { &user_stack[4096>>2], 0x10};
```

ä¹Ÿå°±æ˜¯å°†é«˜ä½ 0x10 ç»™ ssï¼Œä½ä½ `user_stack [4096>>2]` çš„å…ƒç´ çš„ä¸‹ä¸€ä¸ªåœ°å€å€¼ç»™ espï¼Œ0x10 ä¹Ÿå°±æ˜¯ 0x0001_0000 è¡¨ç¤ºæŒ‡å‘å…¨å±€æè¿°ç¬¦çš„ç¬¬ 0x0001_0 ä¸ªæ®µï¼Œä¹Ÿå°±æ˜¯ç¬¬ 2 ä¸ªæ®µä¸º data æ®µï¼Œå…¶åŸºåœ°å€ä¸º 0ã€‚

`call setup_idt` è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨ `call setup_gdt` è®¾ç½®å…¨å±€æè¿°ç¬¦è¡¨

ç„¶ååˆé‡æ–°è®¾ç½®ä¸€éï¼Œä¸ºä»€ä¹ˆè¦é‡æ–°è®¾ç½®ï¼Ÿåœ¨ä¸Šé¢è®¾ç½®ä¸­æ–­/å…¨å±€æè¿°ç¬¦è¡¨çš„æ—¶å€™ï¼Œä¿®æ”¹äº† gdtï¼Œæ‰€ä»¥è¦é‡æ–°è®¾ç½®æ‰ä¼šç”Ÿæ•ˆã€‚

æ¥ä¸‹æ¥é‡ç‚¹çœ‹ `setup_idt`/`setup_gdt`ã€‚

é…ç½®å®Œ idt å’Œ gdt åï¼Œæ¥ç€ç»§ç»­å¾€ä¸‹èµ°ï¼Œè·³è½¬åˆ° `after_page_tables` åï¼Œå…ˆæ˜¯å‡ ä¸ª `push`ï¼Œå…¶ä¸­åŒ…å«äº† c è¯­è¨€çš„ä¸–ç•Œçš„åœ°å€ï¼Œç„¶åä¸€ä¸ªè·³è½¬åˆ° `setup_paging`ï¼Œç»™ `ecx` åˆ†é…å¤§å°ä¸º 5\*1024ï¼ˆ5pagesï¼‰,ç„¶åå°† eax æ¸…é›¶ï¼Œedi æ¸…é›¶ã€‚æ¥ç€å°† al ä¸­çš„æ•°æ®ï¼ˆ0ï¼‰å¡«å……åˆ° edi èµ·å§‹çš„ä½ç½®ï¼ˆ0ï¼‰å¤„ï¼Œæ–¹å‘ä¸ºæ­£å‘ï¼Œå¤§å°ä¸º 5\*1024\*4ã€‚ï¼ˆä¹Ÿå°±æ˜¯è¯´ **ä»é›¶åœ°å€å¼€å§‹å‰ 20k å†…å­˜æ¸…é›¶**ï¼‰

> cld;rep;stosl
> cld è®¾ç½® edi æˆ–åŒ esi ä¸ºé€’å¢æ–¹å‘ï¼Œrep åš (%ecx) æ¬¡é‡å¤æ“ä½œï¼Œstosl è¡¨ç¤º edi æ¯æ¬¡å¢åŠ  4,è¿™æ¡è¯­å¥è¾¾åˆ°æŒ‰ 4 å­—èŠ‚æ¸…ç©ºå‰ 5\*1024\*4 å­—èŠ‚åœ°å€ç©ºé—´çš„ç›®çš„ã€‚

```c
	jmp after_page_tables
after_page_tables:
	pushl $0		# These are the parameters to main :-)
	pushl $0
	pushl $0
	pushl $L6		# return address for main, if it decides to.
	pushl $_start
	jmp setup_paging
L6:
	jmp L6			# main should never return here, but
				# just in case, we know what happens.

setup_paging:
	movl $1024*5,%ecx		/* 5 pages - pg_dir+4 page tables */
	xorl %eax,%eax
	xorl %edi,%edi			/* pg_dir is at 0x000 */
	cld;rep;stosl
	movl $pg0+7,_pg_dir		/* set present bit/user r/w */
	movl $pg1+7,_pg_dir+4		/*  --------- " " --------- */
	movl $pg2+7,_pg_dir+8		/*  --------- " " --------- */
	movl $pg3+7,_pg_dir+12		/*  --------- " " --------- */
	movl $pg3+4092,%edi
	movl $0xfff007,%eax		/*  16Mb - 4096 + 7 (r/w user,p) */
	std
1:	stosl			/* fill pages backwards - more efficient :-) */
	subl $0x1000,%eax
	jge 1b
	xorl %eax,%eax		/* pg_dir is at 0x0000 */
	movl %eax,%cr3		/* cr3 - page directory start */
	movl %cr0,%eax
	orl $0x80000000,%eax
	movl %eax,%cr0		/* set paging (PG) bit */
	ret			/* this also flushes prefetch-queue */

```

æ¥ç€äº†è§£ä¸€ä¸‹åˆ†é¡µï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å¼€å¯åˆ†æ®µæœºåˆ¶åï¼Œåœ¨ä»£ç ä¸­ç»™å‡ºä¸€ä¸ªå†…å­˜åœ°å€ï¼Œè¦å…ˆç»è¿‡åˆ†æ®µæœºåˆ¶çš„è½¬æ¢ï¼Œæ‰èƒ½å¾—åˆ°æœ€ç»ˆçš„ç‰©ç†åœ°å€ã€‚

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204061044176.png)

è¿™ä¸ªæ˜¯æ²¡æœ‰å¼€å¯åˆ†é¡µæœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œå¼€å¯åˆ†é¡µååˆä¼š **å¤šä¸€æ­¥è½¬æ¢**

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204061044464.png)

åˆ†æ®µæœºåˆ¶å°† **é€»è¾‘åœ°å€** è½¬å˜ **ä¸ºçº¿æ€§åœ°å€**

åˆ†é¡µæœºåˆ¶åœ¨åˆ†æ®µæœºåˆ¶çš„åŸºç¡€ä¸Šå°† **çº¿æ€§åœ°å€è½¬ä¸ºç‰©ç†åœ°å€**

åˆ†é¡µæœºåˆ¶å°†ä¸€ä¸ª 32 ä½çº¿æ€§åœ°å€åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š

10 ä½ï¼š10 ä½ï¼š12 ä½ï¼Œåˆ†åˆ«ä¸ºé¡µç›®å½•è¡¨ï¼šé¡µè¡¨ï¼šé¡µå†…åç§»ã€‚

é€šè¿‡é«˜ 10 ä½å»é¡µç›®å½•è¡¨ä¸­æ‰¾å‡ºç´¢å¼•å¯¹åº”çš„é¡µç›®å½•é¡¹ï¼Œåœ¨è¯¥ç›®å½•é¡¹å†… ä¸­ 10 ä½æ‰¾å‡ºç´¢å¼•å¯¹åº”çš„é¡µè¡¨é¡¹ï¼Œå…¶å¯¹åº”çš„å€¼åœ¨åŠ ä¸Šé¡µå†…åç§»å°±æ˜¯å®é™…çš„ç‰©ç†åœ°å€ã€‚

è¿™ä¸€åˆ‡çš„æ“ä½œç”±ä¸€ä¸ªè®¡ç®—æœºç¡¬ä»¶ MMUï¼ˆMemory Management Unitï¼Œå†…å­˜ç®¡ç†å•å…ƒï¼‰å°†çº¿æ€§åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰è½¬æ¢ä¸ºç‰©ç†åœ°å€

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204061938387.png)

è¿™ä¸ªé¡µè¡¨æ–¹æ¡ˆå«äºŒçº§é¡µè¡¨ï¼Œç¬¬ä¸€çº§å« **é¡µç›®å½•è¡¨ PDE**ï¼Œç¬¬äºŒçº§å« **é¡µè¡¨ PTE**ï¼Œç»“æ„å¦‚ä¸‹

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204062005230.png)

ç„¶åå°† CR0 å¯„å­˜å™¨çš„ PGï¼ˆ31 ä½ï¼‰ç½® 1ï¼Œå³å¯å¼€å¯åˆ†é¡µæœºåˆ¶ï¼Œä¹‹å MMU å°±å¯ä»¥å¸®æˆ‘ä»¬è¿›è¡Œåˆ†é¡µçš„è½¬æ¢äº†ã€‚

æ­¤åæŒ‡ä»¤ä¸­çš„å†…å­˜åœ°å€ï¼Œå°±å…ˆè¦ç»è¿‡åˆ†æ®µæœºåˆ¶çš„è½¬æ¢ï¼Œåœ¨ç»è¿‡åˆ†é¡µæœºåˆ¶çš„è½¬æ¢ï¼Œæœ€ç»ˆå˜æˆç‰©ç†åœ°å€ã€‚

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204062031578.png)

```c
setup_paging:
	movl $1024*5,%ecx		/* 5 pages - pg_dir+4 page tables */
	xorl %eax,%eax
	xorl %edi,%edi			/* pg_dir is at 0x000 */
	cld;rep;stosl
	movl $pg0+7,_pg_dir		/* set present bit/user r/w */
	movl $pg1+7,_pg_dir+4		/*  --------- " " --------- */
	movl $pg2+7,_pg_dir+8		/*  --------- " " --------- */
	movl $pg3+7,_pg_dir+12		/*  --------- " " --------- */
	movl $pg3+4092,%edi
	movl $0xfff007,%eax		/*  16Mb - 4096 + 7 (r/w user,p) */
	std
1:	stosl			/* fill pages backwards - more efficient :-) */
	subl $0x1000,%eax
	jge 1b
	xorl %eax,%eax		/* pg_dir is at 0x0000 */
	movl %eax,%cr3		/* cr3 - page directory start */
	movl %cr0,%eax
	orl $0x80000000,%eax
	movl %eax,%cr0		/* set paging (PG) bit */
	ret			/* this also flushes prefetch-queue */
```

å‰é¢æˆ‘ä»¬äº†è§£åˆ°å‰ 4 è¡Œä»£ç æ˜¯ **ä» 0 å¼€å§‹ï¼Œå°†å‰ 1024\*5\*4 å­—èŠ‚ç©ºé—´æ¸…é›¶**

æ¥ç€å¾€ä¸‹èµ°ï¼Œå››ä¸ª movl æŒ‡ä»¤å°† `$pg0+7` è¿™ä¸ªåœ°å€ç»™åˆ° `_pg_dir`ï¼ˆ0 åœ°å€å¤„ï¼‰ï¼Œåé¢ä¾æ¬¡å°† pg1ã€pg2ã€pg3 åœ°å€ç»™ `_pg_dir + 4ã€8ã€12` å¤„ï¼Œæ„å»ºé¡µç›®å½•è¡¨ã€‚

è€Œ pg0ã€1ã€2ã€3 åˆ†åˆ«ä¸º 0x1000ã€0x2000ã€0x3000ã€0x4000

```c
.org 0x1000
pg0:

.org 0x2000
pg1:

.org 0x3000
pg2:

.org 0x4000
pg3:

.org 0x5000
```

æ‰€ä»¥é¡µç›®å½•è¡¨ä¸­å­˜å‚¨çš„æ•°æ®ä¹Ÿå°±ä¸º 0x1007ã€0x2007ã€0x3007ã€0x3007ï¼Œå¯¹åº”é¡µè¡¨åœ°å€ä¸º 1ã€2ã€3ã€4ï¼ˆ0x1007 >> 12ï¼‰

![](https://cdn.jsdelivr.net/gh/Gonglja/imgur/img/202204070903895.png)

æ¥ç€å¾€ä¸‹èµ° ç»™ edi èµ‹å€¼ pg3+4092 ä¹Ÿå°±æ˜¯ 0x4ffcï¼Œä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªï¼Ÿæ²¡ææ¸…æ¥š

ç»™ eax èµ‹å€¼ 0xfff007ï¼Œå¯¹åº”çš„ä¹Ÿå°±æ˜¯æœ€å¤§ 4096 ä¸ª 4kï¼Œä¹Ÿå°±æ˜¯ 16M å†…å­˜ï¼Œç„¶åä¸€ä¸ª std;stosl å‘½ä»¤è¡¨ç¤ºä»¥ edi ä¸ºèµ·å§‹ä½ç½® 0x4ffcï¼Œæ¯æ¬¡å‡å° 4 å­—èŠ‚ï¼Œå°†å¯¹åº”çš„ 4k åœ°å€å†™å…¥åˆ°é¡µè¡¨ä¸­ã€‚ç„¶å eax å‡æ‰ä¸€ä¸ª 4kï¼Œjge å¤§äºç­‰äºè½¬ç§»ï¼Œç„¶åè·³è½¬åˆ°æ‰§è¡Œ stoslï¼Œè¿™æ ·å°±å°† 16M å†…çš„ 4k ç©ºé—´åœ°å€å†™å…¥åˆ°é¡µè¡¨ä¸­ã€‚

```c
	xorl %eax,%eax		/* pg_dir is at 0x0000 */
	movl %eax,%cr3		/* cr3 - page directory start */
	movl %cr0,%eax
	orl $0x80000000,%eax
	movl %eax,%cr0		/* set paging (PG) bit */
	ret			/* this also flushes prefetch-queue */
```

å…ˆç»™ eax æ¸… 0ï¼Œç„¶åè®¾ç½® cr3ï¼Œè®¾ç½®é¡µç›®å½•è¡¨åœ°å€ã€‚

æ¥ç€å°±æ˜¯å°† cr0 çš„ç¬¬ 31 ä½ç½® 1ï¼Œå†™å› cr0ï¼Œå¼€å¯åˆ†é¡µæœºåˆ¶ã€‚

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206081846349.png)

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206082006590.png)

è®¾ç½® pg_dirï¼Œåˆ° cr3ï¼Œå°† cr0 çš„æœ€é«˜ä½ç½®ä¸º 1ã€‚

```c
	xorl %eax,%eax		/* pg_dir is at 0x0000 */
	movl %eax,%cr3		/* cr3 - page directory start */
	movl %cr0,%eax
	orl $0x80000000,%eax
	movl %eax,%cr0		/* set paging (PG) bit */
	ret			/* this also flushes prefetch-queue */
```

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206090010988.png)

##### å¦‚ä½•è¿›å…¥ main

```c
after_page_tables:
	pushl $0		# These are the parameters to main :-)
	pushl $0
	pushl $0
	pushl $L6		# return address for main, if it decides to.
	pushl $main
	jmp setup_paging
L6:
	jmp L6
```

åœ¨ after_page_tables ä¸­è¿ç€ 5 ä¸ª pushï¼Œå°†æ•°æ®ä¾æ¬¡å‹å…¥æ ˆï¼Œæœ€åçš„ç»“æ„å¦‚ä¸‹

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091558424.png)

æ³¨æ„ setup_paging çš„æœ€åä¸€æ¡å‘½ä»¤æ˜¯ retï¼Œret è¢«å«åšè¿”å›æŒ‡ä»¤ï¼Œè¿”å›æŒ‡ä»¤çš„è¯è‚¯å®šå¾—æœ‰è¿”å›çš„åœ°å€ï¼Œè®¡ç®—æœºä¼šæœºæ¢°çš„æŠŠæ ˆé¡¶çš„å…ƒç´ å½“ä½œè¿”å›åœ°å€ã€‚åœ¨å…·ä½“çš„è¯´ï¼Œå°±æ˜¯å°† esp å¯„å­˜å™¨çš„å€¼ç»™åˆ° eip ä¸­ï¼Œè€Œ cs:eip å°±æ˜¯ CPU è¦æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚è€Œæ ˆé¡¶æ­¤æ—¶å­˜æ”¾çš„ä¸º main(start) å‡½æ•°çš„åœ°å€ï¼Œæ‰€ä»¥ ret åå°±ä¼šè·³è½¬åˆ° main(start) ä¸­äº†ã€‚å…¶ä¸­ **L6 ä¼šä½œä¸º main çš„è¿”å›å€¼**ï¼Œä½† main(start) æ˜¯ä¸ä¼šè¿”å›çš„ï¼Œå…¶å®ƒ **ä¸‰ä¸ªå€¼æœ¬æ„æ˜¯ä½œä¸º main(start) å‡½æ•°çš„å‚æ•°**ï¼Œä½†æ²¡æœ‰ç”¨åˆ°ã€‚

> å…³äº ret æŒ‡ä»¤ï¼Œå…¶å® Intel CPU æ˜¯é…åˆ call è®¾è®¡çš„ï¼Œæœ‰å…³ call å’Œ ret æŒ‡ä»¤ï¼Œå³è°ƒç”¨å’Œè¿”å›æŒ‡ä»¤ï¼Œå¯ä»¥å‚è€ƒ Intel æ‰‹å†Œï¼š
> Intel 1 Chapter 6.4 CALLING PROCEDURES USING CALL AND RET

åˆ°æ­¤ï¼Œæ±‡ç¼–éƒ¨åˆ†å°±ç»“æŸäº†ã€‚ä¸»è¦æœ‰å¦‚ä¸‹æ“ä½œï¼Œ

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202204071044648.png)

æ•´ä¸ªå†…å­˜åˆ†å¸ƒå¦‚ä¸‹ï¼š

![](https://note-1251905184.cos.ap-shanghai.myqcloud.com/img/202206091610884.png)

#### å¤§æˆ˜å‰æœŸçš„åˆå§‹åŒ–å·¥ä½œ

æ•´ä¸ª c è¯­è¨€ä¸–ç•Œåˆ†ä¸ºå››éƒ¨åˆ†ï¼Œ

1. å‚æ•°çš„å–å€¼å’Œè®¡ç®—
2. å„ç§åˆå§‹åŒ– init æ“ä½œ
3. åˆ‡æ¢ç”¨æˆ·æ€æ¨¡å¼ï¼Œå¹¶åœ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹ä¸­åšä¸€ä¸ªæœ€ç»ˆçš„åˆå§‹åŒ– init
4. æ­»å¾ªç¯ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿæ²¡æœ‰ä»»åŠ¡è¿è¡Œï¼Œåˆ™ä¸€ç›´é™·å…¥è¿™ä¸ªæ­»å¾ªç¯æ— æ³•è‡ªæ‹”

```c
void main(void)		/* This really IS void, no error here. */
{			/* The startup routine assumes (well, ...) this */
/*
 * Interrupts are still disabled. Do necessary setups, then
 * enable them
 */
	// 1. å‚æ•°çš„å–å€¼å’Œè®¡ç®—
	ROOT_DEV = ORIG_ROOT_DEV;
	drive_info = DRIVE_INFO;
	memory_end = (1<<20) + (EXT_MEM_K<<10);
	memory_end &= 0xfffff000;
	if (memory_end > 16*1024*1024)
		memory_end = 16*1024*1024;
	if (memory_end > 12*1024*1024)
		buffer_memory_end = 4*1024*1024;
	else if (memory_end > 6*1024*1024)
		buffer_memory_end = 2*1024*1024;
	else
		buffer_memory_end = 1*1024*1024;
	main_memory_start = buffer_memory_end;

	// 2. å„ç§åˆå§‹åŒ– init æ“ä½œ
#ifdef RAMDISK
	main_memory_start += rd_init(main_memory_start, RAMDISK*1024);
#endif
	mem_init(main_memory_start,memory_end);
	trap_init();
	blk_dev_init();
	chr_dev_init();
	tty_init();
	time_init();
	sched_init();
	buffer_init(buffer_memory_end);
	hd_init();
	floppy_init();

	// 3. åˆ‡æ¢ç”¨æˆ·æ€æ¨¡å¼ï¼Œå¹¶åœ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹ä¸­åšä¸€ä¸ªæœ€ç»ˆçš„åˆå§‹åŒ– init
	sti();
	move_to_user_mode();
	if (!fork()) {		/* we count on this going ok */
		init();
	}
/*
 *   NOTE!!   For any other task 'pause()' would mean we have to get a
 * signal to awaken, but task0 is the sole exception (see 'schedule()')
 * as task 0 gets activated at every idle moment (when no other tasks
 * can run). For task0 'pause()' just means we go check if some other
 * task can run, and if not we return here.
 */
	// 4. æ­»å¾ªç¯ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿæ²¡æœ‰ä»»åŠ¡è¿è¡Œï¼Œåˆ™ä¸€ç›´é™·å…¥è¿™ä¸ªæ­»å¾ªç¯æ— æ³•è‡ªæ‹”
	for(;;) pause();
}
```

ç¬¬ä¸€éƒ¨åˆ†ï¼šå‚æ•°çš„å–å€¼å’Œè®¡ç®—å†…å­˜è¾¹ç•Œ

åœ¨ä¸Šæ–‡ä¸­ï¼Œé€šè¿‡ setup.s è°ƒç”¨ bios ä¸­æ–­ï¼Œè·å–åˆ°ä¸€äº›è®¾å¤‡å‚æ•°ä¿¡æ¯ï¼Œå­˜æ”¾åœ¨ 0x90000 å¤„ã€‚

åœ¨æ­¤å¤„å°†å‚æ•°å–å‡ºï¼Œå¹¶è®¡ç®—å†…å­˜è¾¹ç•Œ

| å†…å­˜åœ°å€ | é•¿åº¦ (å­—èŠ‚) | åç§° |
| -------- | ---------- | ------------- |
| 0x90000 | 2 | å…‰æ ‡ä½ç½® |
| 0x90002 | 2 | æ‰©å±•å†…å­˜æ•° |
| 0x90004 | 2 | æ˜¾ç¤ºé¡µé¢ |
| 0x90006 | 1 | æ˜¾ç¤ºæ¨¡å¼ |
| 0x90007 | 1 | å­—ç¬¦åˆ—æ•° |
| 0x90008 | 2 | æœªçŸ¥ |
| 0x9000A | 1 | æ˜¾ç¤ºå†…å­˜ |
| 0x9000B | 1 | æ˜¾ç¤ºçŠ¶æ€ |
| 0x9000C | 2 | æ˜¾å¡ç‰¹æ€§å‚æ•° |
| 0x9000E | 1 | å±å¹•è¡Œæ•° |
| 0x9000F | 1 | å±å¹•åˆ—æ•° |
| 0x90080 | 16 | ç¡¬ç›˜ 1 å‚æ•°è¡¨ |
| 0x90090 | 16 | ç¡¬ç›˜ 2 å‚æ•°è¡¨ |
| 0x901FC | 2 | æ ¹è®¾å¤‡å· |

ç¬¬äºŒéƒ¨åˆ†ï¼šå„ç§åˆå§‹åŒ– init æ“ä½œï¼ŒåŒ…æ‹¬å†…å­˜åˆå§‹åŒ–ï¼Œä¸­æ–­åˆå§‹åŒ–ï¼Œå—è®¾å¤‡åˆå§‹åŒ–ï¼Œå­—ç¬¦è®¾å¤‡åˆå§‹åŒ–ï¼Œtty åˆå§‹åŒ–ï¼Œè°ƒåº¦åˆå§‹åŒ–ç­‰

```c
void main() {
	...
	mem_init(main_memory_start,memory_end);
	trap_init();
	blk_dev_init();
	chr_dev_init();
	tty_init();
	time_init();
	sched_init();
	buffer_init(buffer_memory_end);
	hd_init();
	floppy_init();
	...
}
```

ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ‡æ¢ç”¨æˆ·æ€æ¨¡å¼ï¼Œå¹¶åœ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹ä¸­åšä¸€ä¸ªæœ€ç»ˆçš„åˆå§‹åŒ– init

init() å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œè®¾ç½®ç»ˆç«¯çš„æ ‡å‡† IOï¼Œå¹¶ä¸”åœ¨åˆ›å»ºå‡ºä¸€ä¸ªæ‰§è¡Œ shell ç¨‹åºçš„è¿›ç¨‹ç”¨æ¥æ¥æ”¶ç”¨æˆ·çš„å‘½ä»¤ï¼Œåˆ°æ­¤å°±è¿›å…¥äº†çœŸæ­£çš„ç³»ç»Ÿä¸­ã€‚

```c
void main() {
	...
	sti();
	move_to_user_mode();
	if (!fork()) {		/* we count on this going ok */
		init();
	}
	...
}
```

ç¬¬å››éƒ¨åˆ†ï¼šæ­»å¾ªç¯ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿæ²¡æœ‰ä»»åŠ¡è¿è¡Œï¼Œåˆ™ä¸€ç›´é™·å…¥è¿™ä¸ªæ­»å¾ªç¯æ— æ³•è‡ªæ‹”

```c
void main() {
	...
	for(;;) pause();
}
```

##### ç®¡ç†å†…å­˜å‰çš„ä¸‰ä¸ªè¾¹ç•Œå€¼

```c
voidÂ main(void)Â {
Â Â Â Â ...
Â Â Â Â memory_endÂ =Â (1<<20)Â +Â (EXT_MEM_K<<10);
Â Â Â Â memory_endÂ &=Â 0xfffff000;
Â Â Â Â ifÂ (memory_endÂ >Â 16*1024*1024)
Â Â Â Â Â Â Â Â memory_endÂ =Â 16*1024*1024;
Â Â Â Â ifÂ (memory_endÂ >Â 12*1024*1024)Â 
Â Â Â Â Â Â Â Â buffer_memory_endÂ =Â 4*1024*1024;
Â Â Â Â elseÂ ifÂ (memory_endÂ >Â 6*1024*1024)
Â Â Â Â Â Â Â Â buffer_memory_endÂ =Â 2*1024*1024;
Â Â Â Â else
Â Â Â Â Â Â Â Â buffer_memory_endÂ =Â 1*1024*1024;
Â Â Â Â main_memory_startÂ =Â buffer_memory_end;
Â Â Â Â ...
}
```

å…¶å®è¿™æ®µä»£ç å°±æ˜¯æ ¹æ®ä¸åŒçš„ `memory_end` å¤§å°å»åˆ†é…ä¸åŒå¤§å°çš„ `buffer_memory_end`ï¼Œ

å‡è®¾å†…å­˜æœ‰ 16Mï¼Œåˆ™ `memory_end = 16*1024*1024;` `buffer_memory_end = 4*1024*1024;`ï¼Œæ•´ä¸ªå†…å­˜åˆ’åˆ†ä¹Ÿå°±æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤º

![Pasted image 20221129181317.png](/img/user/Resources/Images/Pasted%20image%2020221129181317.png)

å¾—åˆ° `memory_end`ã€`main_memory_start`ã€`buffer_memory_end` è¾¹ç•Œå€¼åï¼Œåç»­æ€ä¹ˆè®¾ç½®å°±çœ‹ `mem_init` å’Œ `buffer_init` äº†ã€‚

```c
void main() {
	...
	mem_init(main_memory_start,memory_end);
	...
	buffer_init(buffer_memory_end);
	...
}
```

##### mem_init

è¿™éƒ¨åˆ†çš„ä»£ç å…¶å®çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œé€šè¿‡ mem_map æ•°ç»„å»ç®¡ç†å†…å­˜ï¼Œæ€ä¹ˆç®¡ç†çš„å‘¢ï¼Ÿ

ç®€å•æ¥è¯´ï¼šé€šè¿‡ä¸€ä¸ªæ•°ç»„å»æ ‡è®°å†…å­˜å—ï¼ˆ4kbytesï¼‰æœ‰æ²¡æœ‰è¢«ä½¿ç”¨ã€‚4k å†…å­˜é€šå¸¸è¢«å«ä¸º 1 é¡µï¼Œè¿™ç§ç®¡ç†æ–¹å¼å« **åˆ†é¡µç®¡ç†**ï¼Œå°±æ˜¯æŠŠå†…å­˜åˆ†æˆä¸€é¡µä¸€é¡µçš„å•ä½å»ç®¡ç†ã€‚

çœ‹ä»£ç ï¼Œä»£ç å…ˆå¯¹ mem_map æ•°ç»„å…¨éƒ¨èµ‹å€¼ä¸º USEDï¼Œç„¶ååœ¨å¯¹å…¶ä¸­çš„ä¸€éƒ¨åˆ†èµ‹å€¼ä¸º 0ã€‚å…¶ä¸­ USED è¡¨ç¤ºå†…å­˜è¢«å ç”¨ï¼Œå ç”¨äº† 100 æ¬¡ï¼›0 è¡¨ç¤ºæœªä½¿ç”¨ã€‚

PAGING_PAGES ä¸­ PAGING_MEMORY ä¸ºä»€ä¹ˆè¦å³ç§» 12 ä½ï¼Œ2^12 = 4kbytesï¼Œä¸ºåˆ†é¡µç®¡ç†çš„æœ€å°å•ä½

```c
/* these are not to be changed without changing head.s etc */
#define LOW_MEM 0x100000
#define PAGING_MEMORY (15*1024*1024)
#define PAGING_PAGES (PAGING_MEMORY>>12)
#define MAP_NR(addr) (((addr)-LOW_MEM)>>12)
#define USED 100

static long HIGH_MEMORY = 0;
static unsigned char mem_map [ PAGING_PAGES ] = {0,};

// start_mem =  4*1024*1024
// end_mem   = 16*1024*1024
void mem_init(long start_mem, long end_mem)
{
	int i;

	HIGH_MEMORY = end_mem;
	for (i=0 ; i<PAGING_PAGES ; i++)
		mem_map[i] = USED;
	i = MAP_NR(start_mem);
	end_mem -= start_mem;
	end_mem >>= 12;
	while (end_mem-->0)
		mem_map[i++]=0;
}
```

è¿˜æ˜¯å‡è®¾å†…å­˜æœ‰ 16Mï¼Œä¸Šè¿°ä»£ç çš„å‰éƒ¨åˆ†æ˜¯å¯¹ 15M å†…å­˜å…¨éƒ¨æ ‡è®°ä¸º USEDï¼Œè¡¨ç¤ºå†…å­˜è¢«ä½¿ç”¨ï¼›åéƒ¨åˆ†ä» start_mem å¼€å§‹åˆ° end_mem å…¨éƒ¨æ ‡è®°ä¸º 0ï¼Œè¡¨ç¤ºå†…å­˜æœªè¢«ä½¿ç”¨

![Pasted image 20221129184042.png](/img/user/Resources/Images/Pasted%20image%2020221129184042.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼š1M ä»¥ä¸‹æ²¡æœ‰è®°å½•ï¼Œè¿™ä¸ªåŒºåŸŸæ˜¯å†…æ ¸ä»£ç æ‰€åœ¨ï¼Œæ— éœ€ä¹Ÿæ²¡æœ‰æƒé™ç®¡ç†çš„ï¼›

1M-4M åŒºé—´æ˜¯ç¼“å†²åŒºï¼Œè¿™ä¸ªåœ°æ–¹ä¸æ˜¯ä¸»å†…å­˜åŒºåŸŸï¼Œå› æ­¤ç›´æ¥è¢«æ ‡è®°ä¸º USEDï¼Œæ•ˆæœå°±æ˜¯æ— æ³•åˆ†é…ã€‚

4M ä»¥ä¸Šæ˜¯ä¸»å†…å­˜åŒºåŸŸï¼Œåœ¨åˆå§‹åŒ–æ—¶æ— ä»»ä½•ç¨‹åºç”³è¯·ï¼Œå› æ­¤éƒ½ä¸ºé›¶ã€‚

åº”ç”¨ç¨‹åºæ˜¯å¦‚ä½•ç”³è¯·å†…å­˜å‘¢ï¼Ÿæ­¤å¤„æš‚ä¸å±•å¼€ï¼Œç®€å•çœ‹ä¸€ä¸‹ç”³è¯·å†…å­˜çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦‚ä½•ä½¿ç”¨ mem_map è¿™ä¸ªç»“æ„çš„ã€‚

åœ¨ memory.c ä¸­æœ‰ä¸€ä¸ªå‡½æ•° get_free_page() ç”¨äºåœ¨ä¸»å†…å­˜å»ä¸­ç”³è¯·ä¸€é¡µç©ºé—²å†…å­˜é¡µï¼Œå¹¶è¿”å›ç‰©ç†å†…å­˜é¡µçš„èµ·å§‹åœ°å€ã€‚

æ¯”å¦‚åœ¨ fork å­è¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ copy_process å‡½æ•°æ¥èµ‹å€¼è¿›ç¨‹çš„ç»“æ„ä¿¡æ¯ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„æ­¥éª¤å°±æ˜¯ç”³è¯·ä¸€é¡µå†…å­˜ï¼Œç”¨äºå­˜æ”¾è¿›ç¨‹ç»“æ„ä¿¡æ¯ task_struct

```c
int copy_process(int nr,long ebp,long edi,long esi,long gs,long none,
		long ebx,long ecx,long edx,
		long fs,long es,long ds,
		long eip,long cs,long eflags,long esp,long ss)
{
	struct task_struct *p;
	int i;
	struct file *f;

	p = (struct task_struct *) get_free_page();
	...
}
```

çœ‹ä¸€ä¸‹ get_free_page çš„å®ç°ï¼Œæ˜¯å†…è”æ±‡ç¼–ä»£ç ï¼Œå…ˆä¸ç”¨çœ‹æ‡‚ï¼Œæ³¨æ„é‡Œé¢æœ‰ mem_map ç»“æ„çš„ä½¿ç”¨

```c
// é€‰æ‹© mem_map ä¸­çš„é¦–ä¸ªç©ºé—²é¡µé¢ï¼Œå¹¶æ ‡è®°ä¸ºå·²ä½¿ç”¨
unsigned long get_free_page(void)
{
register unsigned long __res asm("ax");

__asm__("std ; repne ; scasb\n\t"
	"jne 1f\n\t"
	"movb $1,1(%%edi)\n\t"
	"sall $12,%%ecx\n\t"
	"addl %2,%%ecx\n\t"
	"movl %%ecx,%%edx\n\t"
	"movl $1024,%%ecx\n\t"
	"leal 4092(%%edx),%%edi\n\t"
	"rep ; stosl\n\t"
	" movl %%edx,%%eax\n"
	"1: cld"
	:"=a" (__res)
	:"0" (0),"i" (LOW_MEM),"c" (PAGING_PAGES),
	"D" (mem_map+PAGING_PAGES-1)
	);
return __res;
}
```

##### trap_init

åœ¨ mem_init å†…å­˜åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œæœ‰è¿™æ ·ä¸€è¡Œä»£ç ï¼Œä¸­æ–­è®¾ç½®åˆå§‹åŒ–

```c
void main(void) {
	...
	trap_init();
	...
}
```

æ‰“å¼€å®ç°ï¼Œå‘ç°é‡Œé¢éƒ½æ˜¯ç±»ä¼¼çš„ä»£ç ï¼Œå…¶å®é‡Œé¢å°±ä¸¤ä¸ªçœ‹ä¼¼æ˜¯å‡½æ•°çš„ä¸œè¥¿

set_trap_gate å’Œ set_system_gate

```c
void trap_init(void)
{
	int i;

	set_trap_gate(0,&divide_error);
	set_trap_gate(1,&debug);
	set_trap_gate(2,&nmi);
	set_system_gate(3,&int3);	/* int3-5 can be called from all */
	set_system_gate(4,&overflow);
	set_system_gate(5,&bounds);
	set_trap_gate(6,&invalid_op);
	set_trap_gate(7,&device_not_available);
	set_trap_gate(8,&double_fault);
	set_trap_gate(9,&coprocessor_segment_overrun);
	set_trap_gate(10,&invalid_TSS);
	set_trap_gate(11,&segment_not_present);
	set_trap_gate(12,&stack_segment);
	set_trap_gate(13,&general_protection);
	set_trap_gate(14,&page_fault);
	set_trap_gate(15,&reserved);
	set_trap_gate(16,&coprocessor_error);
	for (i=17;i<48;i++)
		set_trap_gate(i,&reserved);
	set_trap_gate(45,&irq13);
	outb_p(inb_p(0x21)&0xfb,0x21);
	outb(inb_p(0xA1)&0xdf,0xA1);
	set_trap_gate(39,&parallel_interrupt);
}
```

å®é™…ä¸Šè¿™ä¸¤ä¸ªå¹¶ä¸æ˜¯å‡½æ•°ï¼Œè€Œæ˜¯ä¸¤ä¸ªå®ï¼Œä¸¤ä¸ªå®éƒ½æŒ‡å‘äº†ç›¸åŒçš„å®å®šä¹‰ `_set_gate`

```c
#define _set_gate(gate_addr,type,dpl,addr) \
__asm__ ("movw %%dx,%%ax\n\t" \
	"movw %0,%%dx\n\t" \
	"movl %%eax,%1\n\t" \
	"movl ecx,current\n\t" \
	"je 1f\n\t" \
	"movw %%dx,%1\n\t" \
	"xchgl %%ecx,current\n\t" \
	"ljmp *%0\n\t" \
	"cmpl %%ecx,last_task_used_math\n\t" \
	"jne 1f\n\t" \
	"clts\n" \
	"1:" \
	::"m" (*&__tmp.a),"m" (*&__tmp.b), \
	"d" (_TSS(n)),"c" ((long) task[n])); \
}
```

CPU è§„å®šï¼Œå¦‚æœ ljmp æŒ‡ä»¤åé¢è·Ÿçš„æ˜¯ä¸€ä¸ª tss æ®µï¼Œé‚£ä¹ˆï¼Œä¼šç”±ç¡¬ä»¶å°†å½“å‰å„ä¸ªå¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨å½“å‰è¿›ç¨‹çš„ tss ä¸­ï¼Œå¹¶å°†æ–°è¿›ç¨‹çš„ tss ä¿¡æ¯åŠ è½½åˆ°å„ä¸ªå¯„å­˜å™¨ã€‚

![Pasted image 20221202174010.png](/img/user/Resources/Images/Pasted%20image%2020221202174010.png)

ç®€å•è¯´å°±æ˜¯ï¼Œ**ä¿å­˜å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œæ¢å¤ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œè·³è¿‡å»**ï¼

##### fork

é¦–å…ˆçœ‹ fork å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å®é™…ä¸Šå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„å‡½æ•°ï¼Œä¸ºäº†é«˜å¤ç”¨æ€§ï¼Œå‡å°‘é‡å¤å·¥ä½œï¼Œè€Œé€šè¿‡ å® `_syscall0` å®šä¹‰ï¼Œå±•å¼€åå°±æ˜¯ å®Œæ•´çš„ fork å‡½æ•°ã€‚

å¯¹ç³»ç»Ÿçš„è°ƒç”¨éƒ½æ˜¯é€šè¿‡ `_syscallx` å®ç°çš„ï¼Œå…¶ä¸­çš„ `x` å°±æ˜¯åŒºåˆ«ï¼Œè¡¨ç¤ºè¦ä¼ é€’çš„å‚æ•°ä¸ªæ•°ï¼Œ

æ¯”å¦‚ `_syscall0(int, fork);` æ²¡æœ‰å‚æ•°ï¼Œä¼šç”Ÿæˆ `int fork(void) ...` å‡½æ•°

åœ¨æ¯”å¦‚ `_syscall3(int,write,int,fd,const char *,buf,off_t,count)` æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œä¼šç”Ÿæˆ `int write(int fd, const char* buf, off_t count)...` å‡½æ•°

```c
// init/main.c
static inline fork(void) __attribute__((always_inline));
static inline _syscall0(int,fork)

// include/unistd.h
#define _syscall0(type,name) \
  type name(void) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
	: "=a" (__res) \
	: "0" (__NR_##name)); \
if (__res >= 0) \
	return (type) __res; \
errno = -__res; \
return -1; \
}

// å°†å‚æ•°å¸¦å…¥å
#define _syscall0(int,fork) \
  int fork(void) \
{ \
long __res; \
__asm__ volatile ("int $0x80" \
	: "=a" (__res) \
	: "0" (__NR_fork)); \
if (__res >= 0) \
	return (int) __res; \
errno = -__res; \
return -1; \
}

// ä¹Ÿå°±æ˜¯
int fork(void)
{
	long __res;
	__asm__ volatile ("int $0x80" : "=a" (__res) : "0" (__NR_fork));
	if (__res >= 0)
		return (int) __res;
	errno = -__res;
	return -1;
}
```

è‡³äº `_syscallx` ä¸­çš„å†…å®¹ï¼Œå¤§åŒå°å¼‚ï¼Œä¸»è¦å°±æ˜¯ `int $0x80`ï¼Œé€šè¿‡ä¼ é€’ä¸åŒçš„å‚æ•°ï¼Œå»æ‰§è¡Œä¸åŒçš„åŠŸèƒ½

æ¯”å¦‚ï¼š`_syscall(int, fork)` å±•å¼€åå°±æ˜¯ä¸Šè¿°ä»£ç ï¼Œå…¶ä¼ é€’çš„å‚æ•°ä¸º `__NR_fork` å®ï¼Œä¹Ÿå°±æ˜¯ 2

```c
#define __NR_fork	2
```

ä¸çŸ¥è¿˜æœ‰å°è±¡æ²¡ï¼Œåœ¨å‰é¢æˆ‘ä»¬é…ç½®äº†åºå·ä¸º 0x80 çš„ä¸­æ–­ï¼Œå…¶ä¸­æ–­å¤„ç†å‡½æ•°ä¸º system_call æ‰€ä»¥å½“è§¦å‘ 0x80 ä¸­æ–­åï¼Œä¼šè·³è½¬åˆ° system_call ä¸­æ–­å¤„ç†å‡½æ•°ã€‚

```c
set_system_gate(0x80, &system_call);
```

åœ¨ä¸­æ–­å¤„ç†å‡½æ•° system_call ä¸­ï¼Œæš‚æ—¶ä»…éœ€è¦å…³å¿ƒè¿™ä¸€å¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ã€‚

`call *sys_call_table(,%eax,4)`

```c
// kernel/system_call.s
system_call:
	cmpl $nr_system_calls-1,%eax
	ja bad_sys_call
	push %ds
	push %es
	push %fs
	pushl %edx
	pushl %ecx		# push %ebx,%ecx,%edx as parameters
	pushl %ebx		# to the system call
	movl $0x10,%edx		# set up ds,es to kernel space
	mov %dx,%ds
	mov %dx,%es
	movl $0x17,%edx		# fs points to local data space
	mov %dx,%fs
	call *sys_call_table(,%eax,4)
	pushl %eax
	movl current,%eax
	cmpl $0,state(%eax)		# state
	jne reschedule
	cmpl $0,counter(%eax)		# counter
	je reschedule
```

æ‰€ä»¥å½“ `_syscall(int, fork)` æ—¶ï¼Œä¼šè§¦å‘ 0x80 ä¸­æ–­ï¼Œä¹‹åè¿›å…¥ 0x80 ä¸­æ–­å¤„ç†å‡½æ•° `system_call`ï¼Œä¼ é€’çš„å‚æ•°ä¸º `__NR_fork` (ä¹Ÿå°±æ˜¯ 2 )ï¼Œåœ¨ sys_call_table ä¸­ç´¢å¼•ä¸º 2 è°ƒç”¨çš„å‡½æ•°ä¸º sys_fork

```c
fn_ptr sys_call_table[] = { sys_setup, sys_exit, sys_fork, sys_read,
	sys_write, sys_open, sys_close, sys_waitpid, sys_creat, sys_link,
	sys_unlink, sys_execve, sys_chdir, sys_time, sys_mknod, sys_chmod,
	sys_chown, sys_break, sys_stat, sys_lseek, sys_getpid, sys_mount,
	sys_umount, sys_setuid, sys_getuid, sys_stime, sys_ptrace, sys_alarm,
	sys_fstat, sys_pause, sys_utime, sys_stty, sys_gtty, sys_access,
	sys_nice, sys_ftime, sys_sync, sys_kill, sys_rename, sys_mkdir,
	sys_rmdir, sys_dup, sys_pipe, sys_times, sys_prof, sys_brk, sys_setgid,
	sys_getgid, sys_signal, sys_geteuid, sys_getegid, sys_acct, sys_phys,
	sys_lock, sys_ioctl, sys_fcntl, sys_mpx, sys_setpgid, sys_ulimit,
	sys_uname, sys_umask, sys_chroot, sys_ustat, sys_dup2, sys_getppid,
	sys_getpgrp, sys_setsid, sys_sigaction, sys_sgetmask, sys_ssetmask,
	sys_setreuid,sys_setregid, sys_iam, sys_whoami
};
```

åœ¨ sys_fork ä¸­ï¼Œé¦–å…ˆ `find_empty_process` æ‰¾ä¸€ä¸ªç©ºçš„è¿›ç¨‹ï¼Œç„¶åè°ƒç”¨ `copy_process` å®Œæˆè¿›ç¨‹ç»“æ„çš„å¤åˆ¶

```c
.align 2
sys_fork:
	call find_empty_process
	testl %eax,%eax
	js 1f
	push %gs
	pushl %esi
	pushl %edi
	pushl %ebp
	pushl %eax
	call copy_process
	addl $20,%esp
1:	ret
```

find_empty_process åˆ†ä¸ºä¸‰éƒ¨åˆ†

- é¦–å…ˆåˆ¤æ–­ last_pid æ˜¯å¦å°äº 0ï¼Œå°äº 0 æº¢å‡ºäº†ï¼Œé‡æ–°èµ‹å€¼ä¸º 1ï¼Œèµ·åˆ°ä¿æŠ¤çš„ä½œç”¨
- ç¬¬ä¸€ä¸ªå¾ªç¯ï¼šä» NR_TASKS ä¸ªè¿›ç¨‹æ•°ç»„ä¸­ï¼Œæ‰¾å‡ºä¸€ä¸ªæœªä½¿ç”¨çš„ pid
- ç¬¬äºŒä¸ªå¾ªç¯ï¼Œä» NR_TASKS ä¸ªè¿›ç¨‹æ•°ç»„ä¸­ï¼Œæ‰¾å‡ºä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„è¿›ç¨‹ç»“æ„ï¼Œè¿”å›ç´¢å¼•ä¸‹æ ‡

```c
long last_pid=0;
int find_empty_process(void)
{
	int i;

	repeat:
		if ((++last_pid)<0) last_pid=1;
		for(i=0 ; i<NR_TASKS ; i++)
			if (task[i] && task[i]->pid == last_pid) goto repeat;
	for(i=1 ; i<NR_TASKS ; i++)
		if (!task[i])
			return i;
	return -EAGAIN;
}
```

copy_process

```c
int copy_process(int nr,long ebp,long edi,long esi,long gs,long none,
		long ebx,long ecx,long edx,
		long fs,long es,long ds,
		long eip,long cs,long eflags,long esp,long ss)
{
	struct task_struct *p;
	int i;
	struct file *f;

	p = (struct task_struct *) get_free_page();
	if (!p)
		return -EAGAIN;
	task[nr] = p;

	// NOTE!: the following statement now work with gcc 4.3.2 now, and you
	// must compile _THIS_ memcpy without no -O of gcc.#ifndef GCC4_3
	*p = *current;	/* NOTE! this doesn't copy the supervisor stack */
	p->state = TASK_UNINTERRUPTIBLE;
	p->pid = last_pid;
	p->father = current->pid;
	p->counter = p->priority;
	p->signal = 0;
	p->alarm = 0;
	p->leader = 0;		/* process leadership doesn't inherit */
	p->utime = p->stime = 0;
	p->cutime = p->cstime = 0;
	p->start_time = jiffies;
	p->tss.back_link = 0;
	p->tss.esp0 = PAGE_SIZE + (long) p;
	p->tss.ss0 = 0x10;
	p->tss.eip = eip;
	p->tss.eflags = eflags;
	p->tss.eax = 0;
	p->tss.ecx = ecx;
	p->tss.edx = edx;
	p->tss.ebx = ebx;
	p->tss.esp = esp;
	p->tss.ebp = ebp;
	p->tss.esi = esi;
	p->tss.edi = edi;
	p->tss.es = es & 0xffff;
	p->tss.cs = cs & 0xffff;
	p->tss.ss = ss & 0xffff;
	p->tss.ds = ds & 0xffff;
	p->tss.fs = fs & 0xffff;
	p->tss.gs = gs & 0xffff;
	p->tss.ldt = _LDT(nr);
	p->tss.trace_bitmap = 0x80000000;
	if (last_task_used_math == current)
		__asm__("clts ; fnsave %0"::"m" (p->tss.i387));
	if (copy_mem(nr,p)) {
		task[nr] = NULL;
		free_page((long) p);
		return -EAGAIN;
	}
	for (i=0; i<NR_OPEN;i++)
		if ((f=p->filp[i]))
			f->f_count++;
	if (current->pwd)
		current->pwd->i_count++;
	if (current->root)
		current->root->i_count++;
	if (current->executable)
		current->executable->i_count++;
	set_tss_desc(gdt+(nr<<1)+FIRST_TSS_ENTRY,&(p->tss));
	set_ldt_desc(gdt+(nr<<1)+FIRST_LDT_ENTRY,&(p->ldt));
	p->state = TASK_RUNNING;	/* do this last, just in case */
	return last_pid;
}
```

è¿™ä¸ªå‡½æ•°è¢«åˆ†ä¸ºå‡ éƒ¨åˆ†æ¥åˆ†æï¼š

get_free_pageï¼šæ‰¾åˆ°å†…å­˜ç»“æ„ mem_map ä¸­ç©ºé—²çš„å†…å­˜ï¼Œå¹¶æ ‡è®°ä¸º 1ï¼Œè¡¨ç¤ºè¯¥é¡µå·²ç»è¢«ä½¿ç”¨ï¼Œç®—å‡ºè¯¥é¡µçš„å†…å­˜èµ·å§‹åœ°å€ï¼Œè¿”å›

äºæ˜¯ä¹ï¼Œp å°±æœ‰äº†ä¸€å—ç©ºé—´ï¼Œä½†æ˜¯è¯¥å†…å­˜ä¸­å¹¶æ²¡æœ‰æ•°æ®ã€‚

é¦–å…ˆå°†è¯¥åœ°å€è®°å½•åœ¨ è¿›ç¨‹ç®¡ç†ç»“æ„ `task[]` ä¸­

`*p = *current` **å°†å½“å‰è¿›ç¨‹çš„å…¨éƒ¨å€¼ å®Œå…¨å¤åˆ¶ç»™å³å°†åˆ›å»ºçš„è¿›ç¨‹ p**ï¼Œæ‰€ä»¥ä¹‹åçš„å†…å­˜å›¾å°±æ˜¯è¿™æ ·çš„ã€‚

![Pasted image 20221203235941.png](/img/user/Resources/Images/Pasted%20image%2020221203235941.png)

æ¥ç€å°±æ˜¯ä¿®æ”¹ è¿›ç¨‹çš„ä¸ªæ€§åŒ–æ•°æ®ï¼Œæ¯”å¦‚æ—¶é—´ç‰‡ counterï¼Œä¼˜å…ˆçº§ï¼Œä¸Šä¸‹æ–‡ç¯å¢ƒ tssã€‚

æ­¤å¤„æ³¨æ„ä¸€ç‚¹ ss0 å’Œ esp0ï¼Œè¡¨ç¤º 0 ç‰¹æƒçº§ä¹Ÿå°±æ˜¯å†…æ ¸æ€æ—¶ `ss:esp` çš„æŒ‡å‘

æ¥ä¸‹æ¥å°±æ˜¯ è¿›ç¨‹é¡µè¡¨å’Œæ®µè¡¨çš„å¤åˆ¶ã€‚

çœ‹ä¸€ä¸‹ copy_mem ,

```c
int copy_process(int nr,long ebp,long edi,long esi,long gs,long none,
		long ebx,long ecx,long edx,
		long fs,long es,long ds,
		long eip,long cs,long eflags,long esp,long ss)
{
	...
	copy_mem(nr,p);
	...
}

```

https://mp.weixin.qq.com/s?__biz=Mzk0MjE3NDE0Ng==&mid=2247501866&idx=1&sn=64adec9179345945d095a1a1bdebcdac&chksm=c2c5b287f5b23b9175d8eacf7731b22823a576f78e14d8b93b2e8c9814bcb11076967d878a12&cur_album_id=2123743679373688834&scene=189#wechat_redirect

##### init

## å‚è€ƒ

1.  [è°ƒè¯• Linux æœ€æ—©æœŸçš„ä»£ç ](https://mp.weixin.qq.com/s/cx_vaRTcC29h0pWkJPpqQQ)
2.  [Ubuntu20.04 ç¼–è¯‘å®‰è£… qemu](https://blog.csdn.net/weixin_45709295/article/details/120007503)
3.  [qemu è¿è¡Œè™šæ‹Ÿæœºæ— ååº”ï¼Œåªè¾“å‡ºä¸€è¡Œæç¤ºä¿¡æ¯:VNC server running on 127.0.0.1:5900](https://blog.csdn.net/qq_36393978/article/details/118353939)
4.  [è¿æ¥çš„æ—¶å€™æŒ‡å®š-Ttext å’ŒæŒ‡å®š-Tmap.lds çš„åŒºåˆ«](http://blog.chinaunix.net/uid-26833883-id-3746968.html)
5.  [Linux dd å‘½ä»¤](https://www.runoob.com/linux/linux-comm-dd.html)
6.  [BIOS int 13H ä¸­æ–­ä»‹ç»](http://www.only2fire.com/archives/87.html)
7.  [æ±‡ç¼–æŒ‡ä»¤â€”â€”ç”¨ GDB è°ƒè¯•æ±‡ç¼–](https://zhuanlan.zhihu.com/p/259625135)
8.  [åˆ©ç”¨ BIOS ä¸­æ–­ INT 0x10 æ˜¾ç¤ºå­—ç¬¦å’Œå­—ç¬¦ä¸²](https://blog.csdn.net/judyge/article/details/52289231)
